<p><span style="font-size: 12px; ">原文：</span><a target="_blank" href="http://rdc.taobao.com/team/jm/archives/1334 "><span style="font-size: 12px;">http://rdc.taobao.com/team/jm/archives/1334</span><span style="font-size: 12px; ">&nbsp;</span></a></p> 
<p><span style="font-size: 12px; ">(所有要下载的文件都在这里：</span><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-1320" jquery16107410470645460563="1"><span style="font-size: 12px; ">https://issues.apache.org/jira/browse/ZOOKEEPER-1320</span></a><span style="font-size: 12px; ">) &nbsp;&nbsp;</span></p> 
<p> </p>
<p><span style="font-size: 12px; ">&nbsp; &nbsp; &nbsp;ZooKeeper功能定位专一，这“导致”了他并不支持一些“非主流”功能。但是有时候，作为ZooKeeper管理员还是很需要某些功能：<strong>比如通过指定ip的方式，拒绝某个客户端的连接和操作请求</strong>。&nbsp; 目前ZooKeeper官方的说法是，通过配置iptables来实现这个需求。（另外，ZK能够设置单个客户端的最大连接数，但是对于突发情况，这个貌似是没用的，因为需要重启）。对于那些有Server的系统来说，这个功能其实还是蛮需要的，身边同事负责的系统，也有因为某个客户端的使用不当，影响Server性能的。</span></p> 
<p><span style="font-size: 12px; ">&nbsp;&nbsp; 我稍微修改了下zk的代码，目前已经支持动态limitedIp配置，至多10s（可配置）能够对指定客户端进行拦截，从而防止单个或若干个客户端对zk server的冲击, 禁止某个或某些ip对zk Server 的连接。已经给内部一个日志分析系统试用了。代码的patch和基于3.3.3-rc0 build出来的 zookeeper-3.3.3.jar_iplimited都可以到这里下载： </span><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-1320" target="_blank" jquery16107410470645460563="2"><span style="font-size: 12px; ">ZOOKEEPER-1320</span></a><span style="font-size: 12px; ">&nbsp;</span></p> 
<p><span style="font-size: 12px; ">&nbsp;<strong>How to use this feature:</strong><br> 1. Download&nbsp;ZOOKEEPER-1320-iplimited.patch, and patch it on you zookeeper server source code, and rebuild you project. Or you can download the zookeeper-3.3.3.jar_iplimited and rename it to zookeeper-3.3.3.jar.<br> 2. Replace zookeeper-3.3.3.jar of %ZK_HOME%/<br> 3. Start it.<br> 4. Use ./zkCli.sh to connect to the server, and use commands as follow:<br> set /zookeeper/extends/skip_limited_ip false<br> set /zookeeper/extends/limited_ip 1.1.1.1,1.1.1.2,1.1.1.3&nbsp;<br> 5. Use these command in runtime feel free, take effect within 10 seconds.<br> 6. Note: Use comma with English state input method.<br> 7. Enjoy.</span></p> 
<p><span style="font-size: 12px; ">1. 下载&nbsp;ZOOKEEPER-1320-iplimited.patch，打到你的zk源代码上，然后重新build一次。或者可以直接zookeeper-3.3.3.jar_iplimited (这个是我在3.3.3-rc0基础上build的)，并重命名为zookeeper-3.3.3.jar。<br> 2. 替换server上 %ZK_HOME%中的zookeeper-3.3.3.jar。<br> 3. 启动zk。<br> 4. 通过命令方式 ./zkCli.sh 连接zk，进行如下操作：<br> set /zookeeper/extends/skip_limited_ip false<br> set /zookeeper/extends/limited_ip 1.1.1.1,1.1.1.2,1.1.1.3&nbsp;<br> 注意：不同ip之间用英文状态 , 隔开。以后可以随时执行以上命令，至多10s内生效。</span></p> 
<p><span style="font-size: 12px; "><strong>稍后会给出开启这个功能后对ZK Server 性能影响，注意，</strong><strong>三台ZK Server配置：4核2台，8核一台，内存都是4GB，zk日志和数据所在挂载点磁盘大小：都是8G，（不断在清理zk日志。。。），另外，这几台机器上还有其它java程序在运行。因此，本次测试重在对比，请不要太关注绝对值（绝对的性能测试以及丰富的测试用例在</strong></span><strong><a href="http://rdc.taobao.com/team/jm/archives/1070"><span style="font-size: 12px; ">这里</span></a><span style="font-size: 12px; ">）。另外，我也测试了对session建立的测试，但是session本身受网络影响，波动非常大，这里就不给出了。<span style="color: rgb(255, 0, 0); ">点击图片查看大图</span></span></strong></p> 
<p> </p>
<p><strong>纯读性能</strong></p> 
<p><a href="http://img1.51cto.com/attachment/201203/203733213.jpg" target="_blank"><img onload="if(this.width>650) this.width=650;" src="http://img1.51cto.com/attachment/201203/203733213.jpg" border="0" alt=""></a></p> 
<p> </p>
<p><strong>纯写性能</strong></p> 
<p><a href="http://img1.51cto.com/attachment/201203/203853953.jpg" target="_blank"><img onload="if(this.width>650) this.width=650;" src="http://img1.51cto.com/attachment/201203/203853953.jpg" border="0" alt=""></a></p> 
<p></p> 
<p></p> 
<p></p>
<p>本文出自 “<a href="http://nileader.blog.51cto.com">ni掌柜的IT专栏</a>” 博客，请务必保留此出处<a href="http://nileader.blog.51cto.com/1381108/795529">http://nileader.blog.51cto.com/1381108/795529</a></p>
