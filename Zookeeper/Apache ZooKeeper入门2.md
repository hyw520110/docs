<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 15px; margin-left: 10px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; color: rgb(64, 64, 64); font-family: Verdana, Tahoma, Arial, sans-serif; font-size: 12px; line-height: 18px; text-align: left; background-color: rgb(255, 255, 255); ">&nbsp; &nbsp;记得在大约在2006年的时候Google出了Chubby来解决分布一致性的问题(distributed consensus problem)，所有集群中的服务器通过Chubby最终选出一个Master Server ，最后这个Master Server来协调工作。简单来说其原理就是：在一个分布式系统中，有一组服务器在运行同样的程序，它们需要确定一个Value，以那个服务器提供的信息为主/为准，当这个服务器经过n/2+1的方式被选出来后，所有的机器上的Process都会被通知到这个服务器就是主服务器 Master服务器，大家以他提供的信息为准。很想知道Google Chubby中的奥妙，可惜人家Google不开源，自家用。</p> 
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 15px; margin-left: 10px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; color: rgb(64, 64, 64); font-family: Verdana, Tahoma, Arial, sans-serif; font-size: 12px; line-height: 18px; text-align: left; background-color: rgb(255, 255, 255); ">&nbsp; 但是在2009年3年以后沉默已久的Yahoo在Apache上推出了类似的产品ZooKeeper，并且在Google原有Chubby的设计思想上做了一些改进，因为ZooKeeper并不是完全遵循Paxos协议，而是基于自身设计并优化的一个2 phase commit的协议，如图所示：<br style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; "> <img onload="if(this.width>650) this.width=650;" alt="" src="http://hadoop.apache.org/zookeeper/docs/r3.2.1/images/2pc.jpg" style="margin-top: 5px; margin-right: 5px; margin-bottom: 5px; margin-left: 5px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; width: 400px; height: 204px; "></p> 
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 15px; margin-left: 10px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; color: rgb(64, 64, 64); font-family: Verdana, Tahoma, Arial, sans-serif; font-size: 12px; line-height: 18px; text-align: left; background-color: rgb(255, 255, 255); ">&nbsp; ZooKeeper跟Chubby一样用来存放一些相互协作的信息(Coordination)，这些信息比较小一般不会超过1M，在zookeeper中是以一种hierarchical tree的形式来存放，这些具体的Key/Value信息就store在tree node中，如图所示：</p> 
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 15px; margin-left: 10px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; color: rgb(64, 64, 64); font-family: Verdana, Tahoma, Arial, sans-serif; font-size: 12px; line-height: 18px; text-align: left; background-color: rgb(255, 255, 255); "><img onload="if(this.width>650) this.width=650;" alt="zookeeper znode tree" src="http://www.igvita.com/posts/10/fs-zookeeper.png" style="margin-top: 5px; margin-right: 5px; margin-bottom: 5px; margin-left: 5px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; "></p> 
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 15px; margin-left: 10px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; color: rgb(64, 64, 64); font-family: Verdana, Tahoma, Arial, sans-serif; font-size: 12px; line-height: 18px; text-align: left; background-color: rgb(255, 255, 255); ">当有事件导致node数据，例如：变更，增加，删除时，Zookeeper就会调用 triggerWatch方法，判断当前的path来是否有对应的监听者(watcher),如果有watcher，会触发其process方法，执行process方法中的业务逻辑，如图所示：<img onload="if(this.width>650) this.width=650;" src="http://niaklq.bay.livefilestore.com/y1piGSH3Kl8DpmN4UCok8LsEv6Vvv09vpcDySSxklC8p6N6WHvCjAbl22xLYtI9s7wKzH_ar62U106hmIk7ugx20yu8Jta796HM/zookeeper-state.jpg?psid=1" alt=""><br style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; "> &nbsp;<strong style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; ">应用实例</strong><br style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; "> &nbsp;&nbsp; ZooKeeper有了上述的这些用途，让我们设想一下，在一个分布式系统中有这这样的一个应用：<br style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; "> &nbsp;&nbsp;&nbsp;&nbsp; 2个任务工厂(Task Factory)一主一从，如果从的发现主的死了以后，从的就开始工作，他的工作就是向下面很多台代理(Agent)发送指令，让每台代理(Agent)获得不同的账户进行分布式并行计算，而每台代理(Agent)中将分配很多帐号，如果其中一台代理(Agent)死掉了，那么这台死掉的代理上的账户就不会继续工作了。<br style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; "> 上述，<strong style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; ">出现了3个最主要的问题</strong>：<br style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; "> &nbsp;&nbsp;&nbsp; 1.Task Factory 主/从一致性的问题<br style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; "> &nbsp;&nbsp;&nbsp; 2.Task Factory 主/从心跳如何用简单+稳定 或者2者折中的方式实现。<br style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; "> &nbsp;&nbsp;&nbsp; 3.一台代理(Agent)死掉了以后，一部分的账户就无法继续工作，需要通知所有在线的代理(Agent)重新分配一次帐号。</p> 
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 15px; margin-left: 10px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; color: rgb(64, 64, 64); font-family: Verdana, Tahoma, Arial, sans-serif; font-size: 12px; line-height: 18px; text-align: left; background-color: rgb(255, 255, 255); ">怕文字阐述的不够清楚，画了系统中的Task Factory和Agent的大概系统关系，如图所示：<br style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; "> &nbsp;<a href="http://public.bay.livefilestore.com/y1ppti4VmhXt7tDOrU4fJQ477YPpB3Aezw8KKfo9mPs1meXL6TH-kIJyqNwajoRn5XXUQ56J7AFeXeNOEKaJ3uwOA/zookeeper-TaskFactory-Agent.png?psid=1" target="_blank" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; color: rgb(0, 0, 0); font-weight: bold; text-decoration: none; "><img onload="if(this.width>650) this.width=650;" alt="zookeeper apache" height="249" src="http://public.bay.livefilestore.com/y1ppti4VmhXt7tDOrU4fJQ472JLbFgcGBDxjXgM74qPkpRnluekoMWqBvv_8COO5S6hxYIuHBo93cUhjlwmcOoO9Q/zookeeper-TaskFactory-Agent.png?psid=1" width="409" style="margin-top: 5px; margin-right: 5px; margin-bottom: 5px; margin-left: 5px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; width: 409px; height: 249px; "></a></p> 
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 15px; margin-left: 10px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; color: rgb(64, 64, 64); font-family: Verdana, Tahoma, Arial, sans-serif; font-size: 12px; line-height: 18px; text-align: left; background-color: rgb(255, 255, 255); ">OK，让我们想想ZooKeeper是不是能帮助我们去解决目前遇到的这3个最主要的问题呢？<br style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; "> <strong style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; ">解决思路</strong><br style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; "> 1. 任务工厂Task Factory都连接到ZooKeeper上，创建节点，设置对这个节点进行监控，监控方法例如：<br style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; "> &nbsp;&nbsp;&nbsp; event= new WatchedEvent(EventType.NodeDeleted, KeeperState.SyncConnected, "/TaskFactory");<br style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; "> &nbsp;&nbsp; 这个方法的意思就是只要Task Factory与zookeeper断开连接后，这个节点就会被自动删除。</p> 
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 15px; margin-left: 10px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; color: rgb(64, 64, 64); font-family: Verdana, Tahoma, Arial, sans-serif; font-size: 12px; line-height: 18px; text-align: left; background-color: rgb(255, 255, 255); ">2.原来主的任务工厂断开了TCP连接，这个被创建的/TaskFactory节点就不存在了，而且另外一个连接在上面的Task Factory可以立刻收到这个事件(Event)，知道这个节点不存在了，也就是说主TaskFactory死了。</p> 
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 15px; margin-left: 10px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; color: rgb(64, 64, 64); font-family: Verdana, Tahoma, Arial, sans-serif; font-size: 12px; line-height: 18px; text-align: left; background-color: rgb(255, 255, 255); ">3.接下来另外一个活着的TaskFactory会再次创建/TaskFactory节点，并且写入自己的ip到znode里面，作为新的标记。</p> 
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 15px; margin-left: 10px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; color: rgb(64, 64, 64); font-family: Verdana, Tahoma, Arial, sans-serif; font-size: 12px; line-height: 18px; text-align: left; background-color: rgb(255, 255, 255); ">4.此时Agents也会知道主的TaskFactory不工作了，为了防止系统中大量的抛出异常，他们将会先把自己手上的事情做完，然后挂起，等待收到Zookeeper上重新创建一个/TaskFactory节点，收到 EventType.NodeCreated 类型的事件将会继续工作。</p> 
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 15px; margin-left: 10px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; color: rgb(64, 64, 64); font-family: Verdana, Tahoma, Arial, sans-serif; font-size: 12px; line-height: 18px; text-align: left; background-color: rgb(255, 255, 255); ">5.原来从的TaskFactory 将自己变成一个主TaskFactory，当系统管理员启动原来死掉的主的TaskFactory，世界又恢复平静了。</p> 
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 15px; margin-left: 10px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; color: rgb(64, 64, 64); font-family: Verdana, Tahoma, Arial, sans-serif; font-size: 12px; line-height: 18px; text-align: left; background-color: rgb(255, 255, 255); ">6.如果一台代理死掉，其他代理他们将会先把自己手上的事情做完，然后挂起，向TaskFactory发送请求，TaskFactory会重新分配(sharding)帐户到每个Agent上了，继续工作。</p> 
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 15px; margin-left: 10px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; color: rgb(64, 64, 64); font-family: Verdana, Tahoma, Arial, sans-serif; font-size: 12px; line-height: 18px; text-align: left; background-color: rgb(255, 255, 255); ">上述内容，大致如图所示：<br style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; "> <a href="http://public.bay.livefilestore.com/y1phQrSqs4W52GO5ZlfV8isgESnMoYYytosj7mYfwAeBa5RpOAYKmV6JwuERkSTmE_IPJQu37NEF0_miQp4LlnkaQ/zookeeper-TaskFactory-Agent2.png?psid=1" target="_blank" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; color: rgb(0, 0, 0); font-weight: bold; text-decoration: none; "><img onload="if(this.width>650) this.width=650;" alt="zookeeper apache" height="268" src="http://niaklq.bay.livefilestore.com/y1pft1BuWHCpwOg7x6RjsQzBYK2fUQqeKRt_3jR90Snfsqhba-N-UVyozI1EXO_Q0YNwdZ3cIK9s6VEifiU1HAyLp4ZM-3mmrEr/zookeeper-TaskFactory-Agent2.png?psid=1" width="485" style="margin-top: 5px; margin-right: 5px; margin-bottom: 5px; margin-left: 5px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; width: 485px; height: 268px; "></a></p> 
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 15px; margin-left: 10px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; color: rgb(64, 64, 64); font-family: Verdana, Tahoma, Arial, sans-serif; font-size: 12px; line-height: 18px; text-align: left; background-color: rgb(255, 255, 255); "><strong style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; ">口水：</strong><br style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; "> 1.以上内容说的还不够好，希望能和有经验的同学们交流一下，说说你们在大规模计算中是如何解决分布式一致性的问题，谢谢</p> 
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 15px; margin-left: 10px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; color: rgb(64, 64, 64); font-family: Verdana, Tahoma, Arial, sans-serif; font-size: 12px; line-height: 18px; text-align: left; background-color: rgb(255, 255, 255); ">2.大量了很多文章，最后的确是看了Hbase部分和zookeeper的源代码 有了点启发。<br style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; "> <a href="http://hbase.apache.org/docs/r0.89.20100726/xref/org/apache/hadoop/hbase/master/ZKMasterAddressWatcher.html" target="_blank" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; color: rgb(0, 0, 0); font-weight: bold; text-decoration: none; ">http://hbase.apache.org/docs/r0.89.20100726/xref/org/apache/hadoop/hbase/master/ZKMasterAddressWatcher.html</a></p> 
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 15px; margin-left: 10px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; color: rgb(64, 64, 64); font-family: Verdana, Tahoma, Arial, sans-serif; font-size: 12px; line-height: 18px; text-align: left; background-color: rgb(255, 255, 255); "><b><br style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; "> </b></p> 
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 15px; margin-left: 10px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; color: rgb(64, 64, 64); font-family: Verdana, Tahoma, Arial, sans-serif; font-size: 12px; line-height: 18px; text-align: left; background-color: rgb(255, 255, 255); "><span style="font-size: 16px; ">原文：</span><a href="http://www.javabloger.com/article/zookeeper-hapood-apache.html" style="font-family: Simsun; line-height: normal; text-align: -webkit-auto; font-size: medium; "><span style="font-size: 16px; ">http://www.javabloger.com/article/zookeeper-hapood-apache.html</span></a></p>
