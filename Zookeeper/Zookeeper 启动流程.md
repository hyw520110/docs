<p style="margin-left:24px;"><span style="font-size:13px;font-family:consolas;">1.</span><span style="font-size:13px;font-family:'宋体';">首先创建一个</span><span style="font-size:13px;font-family:consolas;">ServerConnectionFactory(这里先分析基于direct NIO，3.4引入了netty)</span><span style="font-size:13px;font-family:'宋体';">，用来监听</span><span style="font-size:13px;font-family:consolas;">zkClient</span><span style="font-size:13px;font-family:'宋体';">的消息并创建</span><span style="font-size:13px;font-family:consolas;">ServerConnection</span><span style="font-size:13px;font-family:'宋体';">处理读写请求</span></p>
<p style="margin-left:24px;"><span style="font-size:13px;font-family:consolas;">2.</span><span style="font-size:13px;font-family:consolas;">ZookeeperServer</span><span style="font-size:13px;font-family:'宋体';">进行数据恢复：创建</span><span style="font-size:13px;font-family:consolas;">ZKDatabase</span><span style="font-size:13px;font-family:'宋体';">并将</span><span style="font-size:13px;font-family:consolas;">PlaybackListener</span><span style="font-size:13px;font-family:'宋体';">传入，然后</span><span style="font-size:13px;font-family:consolas;">ZKDB</span><span style="font-size:13px;font-family:'宋体';">首先从</span><span style="font-size:13px;font-family:consolas;">snapshot</span><span style="font-size:13px;font-family:'宋体';">中加载有效的镜像构建</span><span style="font-size:13px;font-family:consolas;">datatree</span><span style="font-size:13px;font-family:'宋体';">，加载完成后由</span><span style="font-size:13px;font-family:consolas;">Playbacklistener</span><span style="font-size:13px;font-family:'宋体';">对已经提交但还没有</span><span style="font-size:13px;font-family:consolas;">apply</span><span style="font-size:13px;font-family:'宋体';">的</span><span style="font-size:13px;font-family:consolas;">log</span><span style="font-size:13px;font-family:'宋体';">进行</span><span style="font-size:13px;font-family:consolas;">reapply,</span><span style="font-size:13px;font-family:'宋体';">并将最后的</span><span style="font-size:13px;font-family:consolas;">zkXid</span><span style="font-size:13px;font-family:'宋体';">返回</span></p>
<p style="margin-left:24px;"><span style="font-size:13px;font-family:consolas;">3.</span><span style="font-size:13px;font-family:consolas;">ServerConnectionFactory</span><span style="font-size:13px;font-family:'宋体';">进行</span><span style="font-size:13px;font-family:consolas;">session</span><span style="font-size:13px;font-family:'宋体';">清理并执行一次</span><span style="font-size:13px;font-family:consolas;">checkpoint</span></p>
<p style="margin-left:24px;"><span style="font-size:13px;font-family:consolas;">4.</span><span style="font-size:13px;font-family:'宋体';">启动</span><span style="font-size:13px;font-family:consolas;">ZookeeperServer</span><span style="font-size:13px;font-family:'宋体';">，同时</span><span style="font-size:13px;font-family:consolas;">SessionTracker</span><span style="font-size:13px;font-family:'宋体';">等线程，将启动请求发送到</span><span style="font-size:13px;font-family:consolas;">RequestProcess chain</span><span style="font-size:13px;font-family:'宋体';">处理后，最后将</span><span style="font-size:13px;font-family:consolas;">ServerConnectionFactory</span><span style="font-size:13px;font-family:'宋体';">传入</span><span style="font-size:13px;font-family:consolas;">.</span></p>
<p><a href="http://img1.51cto.com/attachment/201310/020341628.png" target="_blank"><img onload="if(this.width>650) this.width=650;" src="http://img1.51cto.com/attachment/201310/020341628.png" title="zk server con.png" alt="020341628.png"></a></p>
<p>本文出自 “<a href="http://boylook.blog.51cto.com">MIKE老毕的海贼船</a>” 博客，请务必保留此出处<a href="http://boylook.blog.51cto.com/7934327/1314167">http://boylook.blog.51cto.com/7934327/1314167</a></p>
