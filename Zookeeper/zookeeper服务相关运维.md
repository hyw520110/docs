<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);">尽管zookeeper在编程上有很多的阱陷，API也非常的难用，但zookeeper服务本身可以说是很牢靠的了，所以在网上貌似关于运维的文章比较少。</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);">但省心并不代表不会出麻烦，下面总结下zookeeper运维相关的东东。</p>
<h3 style="margin:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><a style="color:rgb(51,102,153);margin:0px;padding:0px;" name="t0"></a>重要的参考资料</h3>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);">这里有一个很好的Pdf，介绍了很多zookeeper的东东，作者是zookeeper的committer之一：<br>http://www.infoq.com/presentations/Misconfiguration-ZooKeeper<br>另外，这里有一个总结：http://marcin.cylke.com.pl/blog/2013/03/21/zookeeper-tips/<br></p>
<h3 style="margin:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><a style="color:rgb(51,102,153);margin:0px;padding:0px;" name="t1"></a>配置zookeeper开机启动</h3>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);">首先修改bin/zkEnv.sh，配置ZOO_LOG_DIR的环境变量，ZOO_LOG_DIR是zookeeper日志输出目录，ZOO_LOG4J_PROP是log4j日志输出的配置：</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><br></p>
<p><strong>[plain]</strong>&nbsp;<a href="http://blog.csdn.net/hengyunabc/article/details/19006911#" class="ViewSource" title="view plain" style="text-decoration:none;color:rgb(160,160,160);margin:0px 10px 0px 0px;padding:1px;border:none;font-size:9px;width:16px;height:16px;text-indent:-2000px;background-image:url(&quot;http://static.blog.csdn.net/scripts/SyntaxHighlighter/styles/images/default/ico_plain.gif&quot;);background-color:inherit;background-position:0% 0%;background-repeat:no-repeat;" target="_blank">view plain</a><span style="margin:0px;padding:0px;">&nbsp;<a href="http://blog.csdn.net/hengyunabc/article/details/19006911#" class="CopyToClipboard" title="copy" style="text-decoration:none;color:rgb(160,160,160);margin:0px 10px 0px 0px;padding:1px;border:none;font-size:9px;width:16px;height:16px;text-indent:-2000px;background-image:url(&quot;http://static.blog.csdn.net/scripts/SyntaxHighlighter/styles/images/default/ico_copy.gif&quot;);background-color:inherit;background-position:0% 0%;background-repeat:no-repeat;" target="_blank">copy</a></span><span style="margin:0px;padding:0px;"></span></p>
<ol start="1" style="padding:0px;border:none;color:rgb(92,92,92);margin-bottom:1px;margin-left:45px;background-color:rgb(255,255,255);" class="list-paddingleft-2">
 <li><p><span style="margin:0px;padding:0px;border:none;color:#000000;background-color:inherit;"><span style="margin:0px;padding:0px;border:none;background-color:inherit;">if&nbsp;[&nbsp;"x${ZOO_LOG_DIR}"&nbsp;=&nbsp;"x"&nbsp;]&nbsp;&nbsp;</span></span></p></li>
 <li><p><span style="margin:0px;padding:0px;border:none;color:#000000;background-color:inherit;">then&nbsp;&nbsp;</span></p></li>
 <li><p><span style="margin:0px;padding:0px;border:none;color:#000000;background-color:inherit;">&nbsp;&nbsp;&nbsp;&nbsp;ZOO_LOG_DIR="$ZOOBINDIR/../logs"&nbsp;&nbsp;</span></p></li>
 <li><p><span style="margin:0px;padding:0px;border:none;color:#000000;background-color:inherit;">fi&nbsp;&nbsp;</span></p></li>
 <li><p><span style="margin:0px;padding:0px;border:none;color:#000000;background-color:inherit;">&nbsp;&nbsp;</span></p></li>
 <li><p><span style="margin:0px;padding:0px;border:none;color:#000000;background-color:inherit;">if&nbsp;[&nbsp;"x${ZOO_LOG4J_PROP}"&nbsp;=&nbsp;"x"&nbsp;]&nbsp;&nbsp;</span></p></li>
 <li><p><span style="margin:0px;padding:0px;border:none;color:#000000;background-color:inherit;">then&nbsp;&nbsp;</span></p></li>
 <li><p><span style="margin:0px;padding:0px;border:none;color:#000000;background-color:inherit;">&nbsp;&nbsp;&nbsp;&nbsp;ZOO_LOG4J_PROP="INFO,ROLLINGFILE"&nbsp;&nbsp;</span></p></li>
 <li><p><span style="margin:0px;padding:0px;border:none;color:#000000;background-color:inherit;">fi&nbsp;&nbsp;</span></p></li>
</ol>
<p><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"></p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><br></p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);">再在/etc/init.d目录下增加zookeeper1文件，并加个可执行权限：</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><br></p>
<p><strong>[plain]</strong>&nbsp;<a href="http://blog.csdn.net/hengyunabc/article/details/19006911#" class="ViewSource" title="view plain" style="text-decoration:none;color:rgb(160,160,160);margin:0px 10px 0px 0px;padding:1px;border:none;font-size:9px;width:16px;height:16px;text-indent:-2000px;background-image:url(&quot;http://static.blog.csdn.net/scripts/SyntaxHighlighter/styles/images/default/ico_plain.gif&quot;);background-color:inherit;background-position:0% 0%;background-repeat:no-repeat;" target="_blank">view plain</a><span style="margin:0px;padding:0px;">&nbsp;<a href="http://blog.csdn.net/hengyunabc/article/details/19006911#" class="CopyToClipboard" title="copy" style="text-decoration:none;color:rgb(160,160,160);margin:0px 10px 0px 0px;padding:1px;border:none;font-size:9px;width:16px;height:16px;text-indent:-2000px;background-image:url(&quot;http://static.blog.csdn.net/scripts/SyntaxHighlighter/styles/images/default/ico_copy.gif&quot;);background-color:inherit;background-position:0% 0%;background-repeat:no-repeat;" target="_blank">copy</a></span><span style="margin:0px;padding:0px;">&nbsp;</span><span class="tracking-ad" style="margin:0px;padding:0px;"><a href="https://code.csdn.net/snippets/181204" title="在CODE上查看代码片" style="text-decoration:none;color:rgb(160,160,160);margin:0px 10px 0px 0px;padding:1px;border:none;font-size:9px;width:16px;height:16px;background-image:none;background-color:inherit;background-position:0% 0%;background-repeat:no-repeat;" target="_blank"><img onload="if(this.width>650) this.width=650;" src="https://code.csdn.net/assets/CODE_ico.png" width="12" height="12" alt="在CODE上查看代码片" style="border:none;"></a></span><span class="tracking-ad" style="margin:0px;padding:0px;"><a href="https://code.csdn.net/snippets/181204/fork" title="派生到我的代码片" style="text-decoration:none;color:rgb(160,160,160);margin:0px 10px 0px 0px;padding:1px;border:none;font-size:9px;width:16px;height:16px;background-image:none;background-color:inherit;background-position:0% 0%;background-repeat:no-repeat;" target="_blank"><img onload="if(this.width>650) this.width=650;" src="https://code.csdn.net/assets/ico_fork.svg" width="12" height="12" alt="派生到我的代码片" style="border:none;"></a></span></p>
<ol start="1" style="padding:0px;border:none;color:rgb(92,92,92);margin-bottom:1px;margin-left:45px;background-color:rgb(255,255,255);" class="list-paddingleft-2">
 <li><p><span style="margin:0px;padding:0px;border:none;color:#000000;background-color:inherit;"><span style="margin:0px;padding:0px;border:none;background-color:inherit;">cd&nbsp;/etc/init.d&nbsp;&nbsp;</span></span></p></li>
 <li><p><span style="margin:0px;padding:0px;border:none;color:#000000;background-color:inherit;">touch&nbsp;zookeeper1&nbsp;&nbsp;</span></p></li>
 <li><p><span style="margin:0px;padding:0px;border:none;color:#000000;background-color:inherit;">chmod&nbsp;+x&nbsp;zookeeper1&nbsp;&nbsp;</span></p></li>
</ol>
<p><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">再修改zookeeper1的内容为：</span></p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><br></p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><br></p>
<p><strong>[plain]</strong>&nbsp;<a href="http://blog.csdn.net/hengyunabc/article/details/19006911#" class="ViewSource" title="view plain" style="text-decoration:none;color:rgb(160,160,160);margin:0px 10px 0px 0px;padding:1px;border:none;font-size:9px;width:16px;height:16px;text-indent:-2000px;background-image:url(&quot;http://static.blog.csdn.net/scripts/SyntaxHighlighter/styles/images/default/ico_plain.gif&quot;);background-color:inherit;background-position:0% 0%;background-repeat:no-repeat;" target="_blank">view plain</a><span style="margin:0px;padding:0px;">&nbsp;<a href="http://blog.csdn.net/hengyunabc/article/details/19006911#" class="CopyToClipboard" title="copy" style="text-decoration:none;color:rgb(160,160,160);margin:0px 10px 0px 0px;padding:1px;border:none;font-size:9px;width:16px;height:16px;text-indent:-2000px;background-image:url(&quot;http://static.blog.csdn.net/scripts/SyntaxHighlighter/styles/images/default/ico_copy.gif&quot;);background-color:inherit;background-position:0% 0%;background-repeat:no-repeat;" target="_blank">copy</a></span><span style="margin:0px;padding:0px;">&nbsp;</span><span class="tracking-ad" style="margin:0px;padding:0px;"><a href="https://code.csdn.net/snippets/181204" title="在CODE上查看代码片" style="text-decoration:none;color:rgb(160,160,160);margin:0px 10px 0px 0px;padding:1px;border:none;font-size:9px;width:16px;height:16px;background-image:none;background-color:inherit;background-position:0% 0%;background-repeat:no-repeat;" target="_blank"><img onload="if(this.width>650) this.width=650;" src="https://code.csdn.net/assets/CODE_ico.png" width="12" height="12" alt="在CODE上查看代码片" style="border:none;"></a></span><span class="tracking-ad" style="margin:0px;padding:0px;"><a href="https://code.csdn.net/snippets/181204/fork" title="派生到我的代码片" style="text-decoration:none;color:rgb(160,160,160);margin:0px 10px 0px 0px;padding:1px;border:none;font-size:9px;width:16px;height:16px;background-image:none;background-color:inherit;background-position:0% 0%;background-repeat:no-repeat;" target="_blank"><img onload="if(this.width>650) this.width=650;" src="https://code.csdn.net/assets/ico_fork.svg" width="12" height="12" alt="派生到我的代码片" style="border:none;"></a></span></p>
<ol start="1" style="padding:0px;border:none;color:rgb(92,92,92);margin-bottom:1px;margin-left:45px;background-color:rgb(255,255,255);" class="list-paddingleft-2">
 <li><p><span style="margin:0px;padding:0px;border:none;color:#000000;background-color:inherit;"><span style="margin:0px;padding:0px;border:none;background-color:inherit;">#/bin/sh&nbsp;&nbsp;&nbsp;</span></span></p></li>
 <li><p><span style="margin:0px;padding:0px;border:none;color:#000000;background-color:inherit;">#chkconfig:&nbsp;2345&nbsp;20&nbsp;80&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p></li>
 <li><p><span style="margin:0px;padding:0px;border:none;color:#000000;background-color:inherit;">#&nbsp;description:&nbsp;&nbsp;zookeeper1&nbsp;&nbsp;</span></p></li>
 <li><p><span style="margin:0px;padding:0px;border:none;color:#000000;background-color:inherit;">case&nbsp;$1&nbsp;in&nbsp;&nbsp;</span></p></li>
 <li><p><span style="margin:0px;padding:0px;border:none;color:#000000;background-color:inherit;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;start)&nbsp;su&nbsp;zookeeper&nbsp;/home/zookeeper/zookeeper345_1/bin/zkServer.sh&nbsp;start&nbsp;&nbsp;&nbsp;;;&nbsp;&nbsp;</span></p></li>
 <li><p><span style="margin:0px;padding:0px;border:none;color:#000000;background-color:inherit;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stop)&nbsp;su&nbsp;zookeeper&nbsp;/home/zookeeper/zookeeper345_1/bin/zkServer.sh&nbsp;stop;;&nbsp;&nbsp;</span></p></li>
 <li><p><span style="margin:0px;padding:0px;border:none;color:#000000;background-color:inherit;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;status)&nbsp;su&nbsp;zookeeper&nbsp;/home/zookeeper/zookeeper345_1/bin/zkServer.sh&nbsp;status;;&nbsp;&nbsp;</span></p></li>
 <li><p><span style="margin:0px;padding:0px;border:none;color:#000000;background-color:inherit;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;restart)&nbsp;su&nbsp;zookeeper&nbsp;/home/zookeeper/zookeeper345_1/bin/zkServer.sh&nbsp;restart;;&nbsp;&nbsp;</span></p></li>
 <li><p><span style="margin:0px;padding:0px;border:none;color:#000000;background-color:inherit;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)&nbsp;&nbsp;echo&nbsp;"require&nbsp;start|stop|status|restart"&nbsp;&nbsp;;;&nbsp;&nbsp;</span></p></li>
 <li><p><span style="margin:0px;padding:0px;border:none;color:#000000;background-color:inherit;">esac&nbsp;&nbsp;</span></p></li>
</ol>
<p><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">最后用chkconfig -add zookeeper1 增加服务。这样就搞定了。注意用su zookeeper来切换到zookeeper用户。</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">如果是想配置Upstart方式的启动，可以参考：http://blog.csdn.net/hengyunabc/article/details/18967627</span></p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><br></p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><br></p>
<h3 style="margin:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><a style="color:rgb(51,102,153);margin:0px;padding:0px;" name="t2"></a>zookeeper VIRT虚拟内存占用过大的问题：</h3>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);">这个和zookeeper的实现有关，参考这里：http://zookeeper-user.578899.n2.nabble.com/setting-zookeeper-heap-size-td6983511.html</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);">线上的zookeeper的VIRT有30多G，查看了data, dataLog，总共才几百M。不过一直没什么问题。</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><br></p>
<h3 style="margin:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><a style="color:rgb(51,102,153);margin:0px;padding:0px;" name="t3"></a>Unreasonable length的问题：</h3>
<p><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">https://issues.apache.org/jira/browse/ZOOKEEPER-1513</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">目前线上用的是345版本，而zookeeper最后的release版本就是这个，有大概一年多没更新了。。</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">这个问题有可能是client尝试向zookeeper上放超过1M的数据时，出现的。</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">想修改这个默认配置，则可以修改"jute.maxbuffer"这个环境变量。参考：http://zookeeper.apache.org/doc/r3.3.3/zookeeperAdmin.html</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">但是我们线上是因为端口扫描工具造成的，这个就相当地诡异了。停止端口扫描工具之后，就没有这个问题了。</span></p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><br></p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><br></p>
<h3 style="margin:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><a style="color:rgb(51,102,153);margin:0px;padding:0px;" name="t4"></a>watches数量多的问题：</h3>
<p><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">dubbo对于每个结点都会watch，导致watch数很多，随便都几千个。</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">用wchs，wchc，wchp这些命令可以查看watches的信息，包括总数，每条路径上的watch的数量。每个client的。</span></p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><br></p>
<h3 style="margin:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><a style="color:rgb(51,102,153);margin:0px;padding:0px;" name="t5"></a>查找不能成功启动原因：</h3>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);">zookeeper会有很多原因启动不成功，可以通过:<br></p>
<p><strong>[plain]</strong>&nbsp;<a href="http://blog.csdn.net/hengyunabc/article/details/19006911#" class="ViewSource" title="view plain" style="text-decoration:none;color:rgb(160,160,160);margin:0px 10px 0px 0px;padding:1px;border:none;font-size:9px;width:16px;height:16px;text-indent:-2000px;background-image:url(&quot;http://static.blog.csdn.net/scripts/SyntaxHighlighter/styles/images/default/ico_plain.gif&quot;);background-color:inherit;background-position:0% 0%;background-repeat:no-repeat;" target="_blank">view plain</a><span style="margin:0px;padding:0px;">&nbsp;<a href="http://blog.csdn.net/hengyunabc/article/details/19006911#" class="CopyToClipboard" title="copy" style="text-decoration:none;color:rgb(160,160,160);margin:0px 10px 0px 0px;padding:1px;border:none;font-size:9px;width:16px;height:16px;text-indent:-2000px;background-image:url(&quot;http://static.blog.csdn.net/scripts/SyntaxHighlighter/styles/images/default/ico_copy.gif&quot;);background-color:inherit;background-position:0% 0%;background-repeat:no-repeat;" target="_blank">copy</a></span><span style="margin:0px;padding:0px;">&nbsp;</span><span class="tracking-ad" style="margin:0px;padding:0px;"><a href="https://code.csdn.net/snippets/181204" title="在CODE上查看代码片" style="text-decoration:none;color:rgb(160,160,160);margin:0px 10px 0px 0px;padding:1px;border:none;font-size:9px;width:16px;height:16px;background-image:none;background-color:inherit;background-position:0% 0%;background-repeat:no-repeat;" target="_blank"><img onload="if(this.width>650) this.width=650;" src="https://code.csdn.net/assets/CODE_ico.png" width="12" height="12" alt="在CODE上查看代码片" style="border:none;"></a></span><span class="tracking-ad" style="margin:0px;padding:0px;"><a href="https://code.csdn.net/snippets/181204/fork" title="派生到我的代码片" style="text-decoration:none;color:rgb(160,160,160);margin:0px 10px 0px 0px;padding:1px;border:none;font-size:9px;width:16px;height:16px;background-image:none;background-color:inherit;background-position:0% 0%;background-repeat:no-repeat;" target="_blank"><img onload="if(this.width>650) this.width=650;" src="https://code.csdn.net/assets/ico_fork.svg" width="12" height="12" alt="派生到我的代码片" style="border:none;"></a></span></p>
<ol start="1" style="padding:0px;border:none;color:rgb(92,92,92);margin-bottom:1px;margin-left:45px;background-color:rgb(255,255,255);" class="list-paddingleft-2">
 <li><p><span style="margin:0px;padding:0px;border:none;color:#000000;background-color:inherit;"><span style="margin:0px;padding:0px;border:none;background-color:inherit;">./zkServer.sh&nbsp;start-foreground&nbsp;&nbsp;</span></span></p></li>
</ol>
<p><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">来查看启动时报的是什么异常，同时也可以查看运行过程中的异常。</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">另外，通过：</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"></p>
<p><strong>[plain]</strong>&nbsp;<a href="http://blog.csdn.net/hengyunabc/article/details/19006911#" class="ViewSource" title="view plain" style="text-decoration:none;color:rgb(160,160,160);margin:0px 10px 0px 0px;padding:1px;border:none;font-size:9px;width:16px;height:16px;text-indent:-2000px;background-image:url(&quot;http://static.blog.csdn.net/scripts/SyntaxHighlighter/styles/images/default/ico_plain.gif&quot;);background-color:inherit;background-position:0% 0%;background-repeat:no-repeat;" target="_blank">view plain</a><span style="margin:0px;padding:0px;">&nbsp;<a href="http://blog.csdn.net/hengyunabc/article/details/19006911#" class="CopyToClipboard" title="copy" style="text-decoration:none;color:rgb(160,160,160);margin:0px 10px 0px 0px;padding:1px;border:none;font-size:9px;width:16px;height:16px;text-indent:-2000px;background-image:url(&quot;http://static.blog.csdn.net/scripts/SyntaxHighlighter/styles/images/default/ico_copy.gif&quot;);background-color:inherit;background-position:0% 0%;background-repeat:no-repeat;" target="_blank">copy</a></span><span style="margin:0px;padding:0px;">&nbsp;</span><span class="tracking-ad" style="margin:0px;padding:0px;"><a href="https://code.csdn.net/snippets/181204" title="在CODE上查看代码片" style="text-decoration:none;color:rgb(160,160,160);margin:0px 10px 0px 0px;padding:1px;border:none;font-size:9px;width:16px;height:16px;background-image:none;background-color:inherit;background-position:0% 0%;background-repeat:no-repeat;" target="_blank"><img onload="if(this.width>650) this.width=650;" src="https://code.csdn.net/assets/CODE_ico.png" width="12" height="12" alt="在CODE上查看代码片" style="border:none;"></a></span><span class="tracking-ad" style="margin:0px;padding:0px;"><a href="https://code.csdn.net/snippets/181204/fork" title="派生到我的代码片" style="text-decoration:none;color:rgb(160,160,160);margin:0px 10px 0px 0px;padding:1px;border:none;font-size:9px;width:16px;height:16px;background-image:none;background-color:inherit;background-position:0% 0%;background-repeat:no-repeat;" target="_blank"><img onload="if(this.width>650) this.width=650;" src="https://code.csdn.net/assets/ico_fork.svg" width="12" height="12" alt="派生到我的代码片" style="border:none;"></a></span></p>
<ol start="1" style="padding:0px;border:none;color:rgb(92,92,92);margin-bottom:1px;margin-left:45px;background-color:rgb(255,255,255);" class="list-paddingleft-2">
 <li><p><span style="margin:0px;padding:0px;border:none;color:#000000;background-color:inherit;"><span style="margin:0px;padding:0px;border:none;background-color:inherit;">./zkServer.sh&nbsp;print-cmd&nbsp;&nbsp;</span></span></p></li>
</ol>
<p><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">可以查看zookeeper启动的各个参数，包括java路径等，也可以便于查找问题。</span></p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><br></p>
<h3 style="margin:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><a style="color:rgb(51,102,153);margin:0px;padding:0px;" name="t6"></a>配置自动清理日志：</h3>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);">从3.4.0开始，会自动清理日志了，所以这个通常不用配置。</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);">配置autopurge.snapRetainCount 和 autopurge.purgeInterval 参数。<br>保留的snapshop的数量，默认是3个，最小也是3.</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><br></p>
<p><strong>[plain]</strong>&nbsp;<a href="http://blog.csdn.net/hengyunabc/article/details/19006911#" class="ViewSource" title="view plain" style="text-decoration:none;color:rgb(160,160,160);margin:0px 10px 0px 0px;padding:1px;border:none;font-size:9px;width:16px;height:16px;text-indent:-2000px;background-image:url(&quot;http://static.blog.csdn.net/scripts/SyntaxHighlighter/styles/images/default/ico_plain.gif&quot;);background-color:inherit;background-position:0% 0%;background-repeat:no-repeat;" target="_blank">view plain</a><span style="margin:0px;padding:0px;">&nbsp;<a href="http://blog.csdn.net/hengyunabc/article/details/19006911#" class="CopyToClipboard" title="copy" style="text-decoration:none;color:rgb(160,160,160);margin:0px 10px 0px 0px;padding:1px;border:none;font-size:9px;width:16px;height:16px;text-indent:-2000px;background-image:url(&quot;http://static.blog.csdn.net/scripts/SyntaxHighlighter/styles/images/default/ico_copy.gif&quot;);background-color:inherit;background-position:0% 0%;background-repeat:no-repeat;" target="_blank">copy</a></span><span style="margin:0px;padding:0px;"></span></p>
<ol start="1" style="padding:0px;border:none;color:rgb(92,92,92);margin-bottom:1px;margin-left:45px;background-color:rgb(255,255,255);" class="list-paddingleft-2">
 <li><p><span style="margin:0px;padding:0px;border:none;color:#000000;background-color:inherit;"><span style="margin:0px;padding:0px;border:none;background-color:inherit;">autopurge.snapRetainCount=3&nbsp;&nbsp;</span></span></p></li>
 <li><p><span style="margin:0px;padding:0px;border:none;color:#000000;background-color:inherit;">autopurge.purgeInterval=1&nbsp;&nbsp;</span></p></li>
</ol>
<p><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">参考这里：http://nileader.blog.51cto.com/1381108/932156&nbsp;</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"></p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><br></p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);">另外要注意的是，zookeeper重启会自动清除zookeeper.out日志，所以如果出错要注意先备份这个文件。</p>
<h3 style="margin:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><a style="color:rgb(51,102,153);margin:0px;padding:0px;" name="t7"></a>配置zookeeper.out的位置及log4j滚动日志输出</h3>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);">今天发现线上的bin/zookeeper.out 居然有6G大小。看了下zkServer.sh的代码，这个zookeeper.out实际上是nohup的输出。</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);">而nohup的输出实际上是stdout,stderr的输出，所以还是zookeepe本身的日志配置的问题。</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);">研究了下bin/zkServer.sh和conf/log4j.properties，发现zookeeper其实是有日志相关的输出的配置，只要定义相关的变量就可以了。</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);">主要是ZOO_LOG_DIR和ZOO_LOG4J_PROP这两个环境变量：<br></p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);">zkServer.sh里的：</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><br></p>
<p><strong>[plain]</strong>&nbsp;<a href="http://blog.csdn.net/hengyunabc/article/details/19006911#" class="ViewSource" title="view plain" style="text-decoration:none;color:rgb(160,160,160);margin:0px 10px 0px 0px;padding:1px;border:none;font-size:9px;width:16px;height:16px;text-indent:-2000px;background-image:url(&quot;http://static.blog.csdn.net/scripts/SyntaxHighlighter/styles/images/default/ico_plain.gif&quot;);background-color:inherit;background-position:0% 0%;background-repeat:no-repeat;" target="_blank">view plain</a><span style="margin:0px;padding:0px;">&nbsp;<a href="http://blog.csdn.net/hengyunabc/article/details/19006911#" class="CopyToClipboard" title="copy" style="text-decoration:none;color:rgb(160,160,160);margin:0px 10px 0px 0px;padding:1px;border:none;font-size:9px;width:16px;height:16px;text-indent:-2000px;background-image:url(&quot;http://static.blog.csdn.net/scripts/SyntaxHighlighter/styles/images/default/ico_copy.gif&quot;);background-color:inherit;background-position:0% 0%;background-repeat:no-repeat;" target="_blank">copy</a></span><span style="margin:0px;padding:0px;"></span></p>
<ol start="1" style="padding:0px;border:none;color:rgb(92,92,92);margin-bottom:1px;margin-left:45px;background-color:rgb(255,255,255);" class="list-paddingleft-2">
 <li><p><span style="margin:0px;padding:0px;border:none;color:#000000;background-color:inherit;"><span style="margin:0px;padding:0px;border:none;background-color:inherit;">if&nbsp;[&nbsp;!&nbsp;-w&nbsp;"$ZOO_LOG_DIR"&nbsp;]&nbsp;;&nbsp;then&nbsp;&nbsp;</span></span></p></li>
 <li><p><span style="margin:0px;padding:0px;border:none;color:#000000;background-color:inherit;">mkdir&nbsp;-p&nbsp;"$ZOO_LOG_DIR"&nbsp;&nbsp;</span></p></li>
 <li><p><span style="margin:0px;padding:0px;border:none;color:#000000;background-color:inherit;">fi&nbsp;&nbsp;</span></p></li>
 <li><p><span style="margin:0px;padding:0px;border:none;color:#000000;background-color:inherit;">&nbsp;&nbsp;</span></p></li>
 <li><p><span style="margin:0px;padding:0px;border:none;color:#000000;background-color:inherit;">_ZOO_DAEMON_OUT="$ZOO_LOG_DIR/zookeeper.out"&nbsp;&nbsp;</span></p></li>
 <li><p><span style="margin:0px;padding:0px;border:none;color:#000000;background-color:inherit;">&nbsp;&nbsp;</span></p></li>
 <li><p><span style="margin:0px;padding:0px;border:none;color:#000000;background-color:inherit;">&nbsp;&nbsp;&nbsp;&nbsp;nohup&nbsp;$JAVA&nbsp;"-Dzookeeper.log.dir=${ZOO_LOG_DIR}"&nbsp;"-Dzookeeper.root.logger=${ZOO_LOG4J_PROP}"&nbsp;\&nbsp;&nbsp;</span></p></li>
 <li><p><span style="margin:0px;padding:0px;border:none;color:#000000;background-color:inherit;">&nbsp;&nbsp;&nbsp;&nbsp;-cp&nbsp;"$CLASSPATH"&nbsp;$JVMFLAGS&nbsp;$ZOOMAIN&nbsp;"$ZOOCFG"&nbsp;&gt;&nbsp;"$_ZOO_DAEMON_OUT"&nbsp;2&gt;&amp;1&nbsp;&lt;&nbsp;/dev/null&nbsp;&amp;&nbsp;&nbsp;</span></p></li>
</ol>
<p><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">log4j.properties里的：</span></p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><br></p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><br></p>
<p><strong>[plain]</strong>&nbsp;<a href="http://blog.csdn.net/hengyunabc/article/details/19006911#" class="ViewSource" title="view plain" style="text-decoration:none;color:rgb(160,160,160);margin:0px 10px 0px 0px;padding:1px;border:none;font-size:9px;width:16px;height:16px;text-indent:-2000px;background-image:url(&quot;http://static.blog.csdn.net/scripts/SyntaxHighlighter/styles/images/default/ico_plain.gif&quot;);background-color:inherit;background-position:0% 0%;background-repeat:no-repeat;" target="_blank">view plain</a><span style="margin:0px;padding:0px;">&nbsp;<a href="http://blog.csdn.net/hengyunabc/article/details/19006911#" class="CopyToClipboard" title="copy" style="text-decoration:none;color:rgb(160,160,160);margin:0px 10px 0px 0px;padding:1px;border:none;font-size:9px;width:16px;height:16px;text-indent:-2000px;background-image:url(&quot;http://static.blog.csdn.net/scripts/SyntaxHighlighter/styles/images/default/ico_copy.gif&quot;);background-color:inherit;background-position:0% 0%;background-repeat:no-repeat;" target="_blank">copy</a></span><span style="margin:0px;padding:0px;"></span></p>
<ol start="1" style="padding:0px;border:none;color:rgb(92,92,92);margin-bottom:1px;margin-left:45px;background-color:rgb(255,255,255);" class="list-paddingleft-2">
 <li><p><span style="margin:0px;padding:0px;border:none;color:#000000;background-color:inherit;"><span style="margin:0px;padding:0px;border:none;background-color:inherit;">#&nbsp;&nbsp;</span></span></p></li>
 <li><p><span style="margin:0px;padding:0px;border:none;color:#000000;background-color:inherit;">#&nbsp;Add&nbsp;ROLLINGFILE&nbsp;to&nbsp;rootLogger&nbsp;to&nbsp;get&nbsp;log&nbsp;file&nbsp;output&nbsp;&nbsp;</span></p></li>
 <li><p><span style="margin:0px;padding:0px;border:none;color:#000000;background-color:inherit;">#&nbsp;&nbsp;&nbsp;&nbsp;Log&nbsp;DEBUG&nbsp;level&nbsp;and&nbsp;above&nbsp;messages&nbsp;to&nbsp;a&nbsp;log&nbsp;file&nbsp;&nbsp;</span></p></li>
 <li><p><span style="margin:0px;padding:0px;border:none;color:#000000;background-color:inherit;">log4j.appender.ROLLINGFILE=org.apache.log4j.RollingFileAppender&nbsp;&nbsp;</span></p></li>
 <li><p><span style="margin:0px;padding:0px;border:none;color:#000000;background-color:inherit;">log4j.appender.ROLLINGFILE.Threshold=${zookeeper.log.threshold}&nbsp;&nbsp;</span></p></li>
 <li><p><span style="margin:0px;padding:0px;border:none;color:#000000;background-color:inherit;">log4j.appender.ROLLINGFILE.File=${zookeeper.log.dir}/${zookeeper.log.file}&nbsp;&nbsp;</span></p></li>
</ol>
<p><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"></p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);">而zkServer.sh会加载zkEnv.sh。</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);">因此，其实修改下bin/zkEnv.sh就可以了：</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><a href="https://gist.github.com/hengyunabc/61d74672e7a662a5366c" style="text-decoration:none;color:rgb(51,102,153);margin:0px;padding:0px;" target="_blank">https://gist.github.com/hengyunabc/61d74672e7a662a5366c</a></p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><br></p>
<p><strong>[plain]</strong>&nbsp;<a href="http://blog.csdn.net/hengyunabc/article/details/19006911#" class="ViewSource" title="view plain" style="text-decoration:none;color:rgb(160,160,160);margin:0px 10px 0px 0px;padding:1px;border:none;font-size:9px;width:16px;height:16px;text-indent:-2000px;background-image:url(&quot;http://static.blog.csdn.net/scripts/SyntaxHighlighter/styles/images/default/ico_plain.gif&quot;);background-color:inherit;background-position:0% 0%;background-repeat:no-repeat;" target="_blank">view plain</a><span style="margin:0px;padding:0px;">&nbsp;<a href="http://blog.csdn.net/hengyunabc/article/details/19006911#" class="CopyToClipboard" title="copy" style="text-decoration:none;color:rgb(160,160,160);margin:0px 10px 0px 0px;padding:1px;border:none;font-size:9px;width:16px;height:16px;text-indent:-2000px;background-image:url(&quot;http://static.blog.csdn.net/scripts/SyntaxHighlighter/styles/images/default/ico_copy.gif&quot;);background-color:inherit;background-position:0% 0%;background-repeat:no-repeat;" target="_blank">copy</a></span><span style="margin:0px;padding:0px;"></span></p>
<ol start="1" style="padding:0px;border:none;color:rgb(92,92,92);margin-bottom:1px;margin-left:45px;background-color:rgb(255,255,255);" class="list-paddingleft-2">
 <li><p><span style="margin:0px;padding:0px;border:none;color:#000000;background-color:inherit;"><span style="margin:0px;padding:0px;border:none;background-color:inherit;">if&nbsp;[&nbsp;"x${ZOO_LOG_DIR}"&nbsp;=&nbsp;"x"&nbsp;]&nbsp;&nbsp;</span></span></p></li>
 <li><p><span style="margin:0px;padding:0px;border:none;color:#000000;background-color:inherit;">then&nbsp;&nbsp;</span></p></li>
 <li><p><span style="margin:0px;padding:0px;border:none;color:#000000;background-color:inherit;">&nbsp;&nbsp;&nbsp;&nbsp;ZOO_LOG_DIR="$ZOOBINDIR/../logs"&nbsp;&nbsp;</span></p></li>
 <li><p><span style="margin:0px;padding:0px;border:none;color:#000000;background-color:inherit;">fi&nbsp;&nbsp;</span></p></li>
 <li><p><span style="margin:0px;padding:0px;border:none;color:#000000;background-color:inherit;">&nbsp;&nbsp;&nbsp;</span></p></li>
 <li><p><span style="margin:0px;padding:0px;border:none;color:#000000;background-color:inherit;">if&nbsp;[&nbsp;"x${ZOO_LOG4J_PROP}"&nbsp;=&nbsp;"x"&nbsp;]&nbsp;&nbsp;</span></p></li>
 <li><p><span style="margin:0px;padding:0px;border:none;color:#000000;background-color:inherit;">then&nbsp;&nbsp;</span></p></li>
 <li><p><span style="margin:0px;padding:0px;border:none;color:#000000;background-color:inherit;">&nbsp;&nbsp;&nbsp;&nbsp;ZOO_LOG4J_PROP="INFO,ROLLINGFILE"&nbsp;&nbsp;</span></p></li>
 <li><p><span style="margin:0px;padding:0px;border:none;color:#000000;background-color:inherit;">fi&nbsp;&nbsp;</span></p></li>
</ol>
<p><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"></p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><br></p>
<p><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">还可以修改下conf/log4j.properties，设置滚动日志最多为10个：</span></p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><br></p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><br></p>
<p><strong>[python]</strong>&nbsp;<a href="http://blog.csdn.net/hengyunabc/article/details/19006911#" class="ViewSource" title="view plain" style="text-decoration:none;color:rgb(160,160,160);margin:0px 10px 0px 0px;padding:1px;border:none;font-size:9px;width:16px;height:16px;text-indent:-2000px;background-image:url(&quot;http://static.blog.csdn.net/scripts/SyntaxHighlighter/styles/images/default/ico_plain.gif&quot;);background-color:inherit;background-position:0% 0%;background-repeat:no-repeat;" target="_blank">view plain</a><span style="margin:0px;padding:0px;">&nbsp;<a href="http://blog.csdn.net/hengyunabc/article/details/19006911#" class="CopyToClipboard" title="copy" style="text-decoration:none;color:rgb(160,160,160);margin:0px 10px 0px 0px;padding:1px;border:none;font-size:9px;width:16px;height:16px;text-indent:-2000px;background-image:url(&quot;http://static.blog.csdn.net/scripts/SyntaxHighlighter/styles/images/default/ico_copy.gif&quot;);background-color:inherit;background-position:0% 0%;background-repeat:no-repeat;" target="_blank">copy</a></span><span style="margin:0px;padding:0px;"></span></p>
<ol start="1" class="dp-py list-paddingleft-2" style="padding:0px;border:none;color:rgb(92,92,92);margin-bottom:1px;margin-left:45px;background-color:rgb(255,255,255);">
 <li><p><span style="margin:0px;padding:0px;border:none;color:#000000;background-color:inherit;"><span class="comment" style="margin:0px;padding:0px;border:none;color:rgb(0,130,0);background-color:inherit;">#&nbsp;Max&nbsp;log&nbsp;file&nbsp;size&nbsp;of&nbsp;10MB</span><span style="margin:0px;padding:0px;border:none;background-color:inherit;">&nbsp;&nbsp;</span></span></p></li>
 <li><p><span style="margin:0px;padding:0px;border:none;color:#000000;background-color:inherit;">log4j.appender.ROLLINGFILE.MaxFileSize=<span class="number" style="margin:0px;padding:0px;border:none;background-color:inherit;">10MB</span><span style="margin:0px;padding:0px;border:none;background-color:inherit;">&nbsp;&nbsp;</span></span></p></li>
 <li><p><span style="margin:0px;padding:0px;border:none;color:#000000;background-color:inherit;"><span class="comment" style="margin:0px;padding:0px;border:none;color:rgb(0,130,0);background-color:inherit;">#&nbsp;uncomment&nbsp;the&nbsp;next&nbsp;line&nbsp;to&nbsp;limit&nbsp;number&nbsp;of&nbsp;backup&nbsp;files</span><span style="margin:0px;padding:0px;border:none;background-color:inherit;">&nbsp;&nbsp;</span></span></p></li>
 <li><p><span style="margin:0px;padding:0px;border:none;color:#000000;background-color:inherit;">log4j.appender.ROLLINGFILE.MaxBackupIndex=<span class="number" style="margin:0px;padding:0px;border:none;background-color:inherit;">10</span><span style="margin:0px;padding:0px;border:none;background-color:inherit;">&nbsp;&nbsp;</span></span></p></li>
</ol>
<p><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"></p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><br></p>
<h3 style="margin:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><a style="color:rgb(51,102,153);margin:0px;padding:0px;" name="t8"></a>Too many connections from 错误</h3>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);">这个错误是因为同一个IP的zookeeper socket 连接数大于60了。zookeeper server默认限制每个IP最多60个连接。</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);">这个在测试服务器上出现的，因为测试服务器上太多进程在跑了。。</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);">修改为：</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);">maxClientCnxns=150<br></p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);">http://zookeeper.apache.org/doc/current/zookeeperAdmin.html#sc_advancedConfiguration</p>
<h3 style="margin:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><a style="color:rgb(51,102,153);margin:0px;padding:0px;" name="t9"></a>This ZooKeeper instance is not currently serving requests 的错误提示</h3>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);">当集群里的结点只剩下一台，或者不足半数时，就会出现这个错误提示。</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);">通常在，只启动第一台zookeeper时会报这个错误。</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);">在zookeeper server的日志里，会有类似的日志：</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);">Exception causing close of session 0x0 due to java.io.IOException: ZooKeeperServer not running<br></p>
<h3 style="margin:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><a style="color:rgb(51,102,153);margin:0px;padding:0px;" name="t10"></a>Zookeeper连接速度很慢，Dubbo初始化很慢，应用启动很慢的问题</h3>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);">发现线下环境迁移到新机器后，应用启动变得很慢，本来十几秒启动的应用，变成几分钟才能启动。</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);">启动过程没有报错，只是Dubbo的注册信息日志一直在比较慢地刷。</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);">开始怀疑是网络问题，但是检查了iptables没有开启，用iptraf查看流量，也不高。机器的空闲内存也足够。</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);">再检查Zookeeper的配置，磁盘的空间，应用的dubbo配置，jvm配置，发现都没有问题。</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);">没办法了，用jprofiler来测试下，发现“org.I0Itec.zkclient.ZkClient$1.call”，这个调用耗时比较大。</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);">这样确认是zookeeper本身比较慢，不是应用的问题。</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);">用下面的zookeeper benchmark工具测试了下性能，发现read速度还可能，create/write速度非常慢，qps只有个位数。</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);">于是问了下运维的同事，原来新机器是用共享磁盘的，所以速度很慢。</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);">而zookeeper每次write请求都要写到log日志，并刷到磁盘里，所以非常的慢。</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);">后来运维的同事换为本地磁盘，一切恢复正常。</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><br></p>
<h3 style="margin:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><a style="color:rgb(51,102,153);margin:0px;padding:0px;" name="t11"></a>管理工具：</h3>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><br></p>
<h4 style="margin:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><a style="color:rgb(51,102,153);margin:0px;padding:0px;" name="t12"></a>Zookeeper官方自带的管理员工具：</h4>
<p><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">http://zookeeper.apache.org/doc/trunk/zookeeperAdmin.html &nbsp; &nbsp;官方的命令行工具可以胜任绝大部分工作了。</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"></p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><br></p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><br></p>
<h4 style="margin:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><a style="color:rgb(51,102,153);margin:0px;padding:0px;" name="t13"></a>zktop</h4>
<p><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">https://github.com/phunt/zktop &nbsp;python写的小工具，很有意思</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"></p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><br></p>
<h4 style="margin:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><a style="color:rgb(51,102,153);margin:0px;padding:0px;" name="t14"></a>taokeeper</h4>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);">项目地址：https://github.com/alibaba/taokeeper&nbsp;<br>淘宝出品的一个监控工具，还有可以用脚本来监控的功能。虽然开源了，但是实际上很难用，代码也很难扩展，而且有些jar包是淘宝内部的。<br>我修改了下，可以正常使用，代码地址在：https://github.com/hengyunabc/taokeeper&nbsp;<br>但是我们线上也没有用这个，线上只有zabbix的监控。<br>安装配置参考：<br></p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><br></p>
<h5 style="margin:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><a style="color:rgb(51,102,153);margin:0px;padding:0px;" name="t15"></a>编译</h5>
<p><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">1.下载这两个项目：</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">&nbsp; git clone https://github.com/hengyunabc/common-toolkit.git</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">&nbsp; git clone https://github.com/nileader/zkclient.git</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">&nbsp;&nbsp;</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">&nbsp; 先分别执行 mvn -Dmaven.test.skip install</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">2.下载本项目：</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">&nbsp; git clone https://github.com/hengyunabc/taokeeper.git</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">&nbsp; 执行 &nbsp;mvn -Dmaven.test.skip clean package</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">&nbsp; 到taokeeper-monitor/target/目录就可以看到生成的War包了。</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"></p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><br></p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><br></p>
<h5 style="margin:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><a style="color:rgb(51,102,153);margin:0px;padding:0px;" name="t16"></a>部署</h5>
<p><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">taokeeper使用mysql数据库来保存一些配置和日志。&nbsp;</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">导入taokeeper-build/etc/taokeeper.sql 文件，也可以从这里下载：文件:Taokeeper.sql.zip 。&nbsp;</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">配置tomcat启动参数，增加JVM启动参数：&nbsp;</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">&nbsp;JAVA_OPTS=-DconfigFilePath="~/taokeeper/taokeeper-monitor-config.properties"</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">并在上面的配置中配置好参数，例如：&nbsp;</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><span style="margin:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:pre;background-color:rgb(255,255,255);"></span><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">systemInfo.envName=TEST</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><span style="margin:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:pre;background-color:rgb(255,255,255);"></span><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">#DBCP</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><span style="margin:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:pre;background-color:rgb(255,255,255);"></span><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">dbcp.driverClassName=com.mysql.jdbc.Driver</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><span style="margin:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:pre;background-color:rgb(255,255,255);"></span><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">dbcp.dbJDBCUrl=jdbc:mysql://localhost:3306/taokeeper</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><span style="margin:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:pre;background-color:rgb(255,255,255);"></span><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">dbcp.characterEncoding=GBK</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><span style="margin:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:pre;background-color:rgb(255,255,255);"></span><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">dbcp.username=root</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><span style="margin:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:pre;background-color:rgb(255,255,255);"></span><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">dbcp.password=root</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><span style="margin:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:pre;background-color:rgb(255,255,255);"></span><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">dbcp.maxActive=30</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><span style="margin:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:pre;background-color:rgb(255,255,255);"></span><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">dbcp.maxIdle=10</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><span style="margin:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:pre;background-color:rgb(255,255,255);"></span><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">dbcp.maxWait=10000</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><span style="margin:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:pre;background-color:rgb(255,255,255);"></span><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">#SystemConstant</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><span style="margin:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:pre;background-color:rgb(255,255,255);"></span><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">SystemConstent.dataStoreBasePath=~/taokeeper/</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><span style="margin:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:pre;background-color:rgb(255,255,255);"></span><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">#SSH account of zk server</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><span style="margin:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:pre;background-color:rgb(255,255,255);"></span><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">SystemConstant.userNameOfSSH=hello</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><span style="margin:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:pre;background-color:rgb(255,255,255);"></span><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">SystemConstant.passwordOfSSH=hello</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">其中SSH用户密码要配置对，zookeeper部署的机器要开放SSH服务。&nbsp;</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">把生成的War包改为ROOT.war，放到tomcat的webapps目录下，启动tomcat。&nbsp;</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">如果报log4j错误，则还要配置webapps/ROOT/WEB-INF/classes/log4j.properties 文件。也可以在编绎前先修改好。&nbsp;</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">打开 http://localhost:8080/ ，就可以看到taokeeper的界面了。&nbsp;</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"></p>
<h5 style="margin:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><a style="color:rgb(51,102,153);margin:0px;padding:0px;" name="t17"></a>工作原理</h5>
<p><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">taokeeper通过SSH连接到zookeeper部署的机器上，再在上面执行zookeeper的Four Letter Words来得到统计信息，再分析保存到mysql数据库中。&nbsp;</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">参考：http://zookeeper.apache.org/doc/trunk/zookeeperAdmin.html#sc_zkCommands&nbsp;</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">监控目标机器的负载，也是通过SSH连接到目标机器，再执行top等命令，再分析得到数据。&nbsp;</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"></p>
<h5 style="margin:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><a style="color:rgb(51,102,153);margin:0px;padding:0px;" name="t18"></a>注意事项</h5>
<p><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">在chrome浏览器下，“机器监控”这个功能有时会把信息显示下浏览器的下面，要拉到最后才能看到，并不是这个功能不能工作。&nbsp;</span></p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><br></p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><br></p>
<h4 style="margin:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><a style="color:rgb(51,102,153);margin:0px;padding:0px;" name="t19"></a>Exhibitor</h4>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><br></p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);">这个是Netflix出品的一个监控工具，但实际上也很难用。。</p>
<p><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">Exhibitor的主要功能 监控本机的Zookeeper服务，可以自动重启挂掉的Zookeeper服务；</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">&nbsp;定期备份数据；</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">&nbsp;定期清理Zookeeper日志；</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">&nbsp;提供了一个Web界面可以修改Zookeeper的数据；</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">&nbsp;REST API。</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"></p>
<h5 style="margin:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><a style="color:rgb(51,102,153);margin:0px;padding:0px;" name="t20"></a>Exhibitor安装</h5>
<p><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">Exhibitor提供了三种运行方式：独立的jar文件，War包，core jar。推荐用jar方式运行，配置管理都很方便。&nbsp;</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">安装方法可以参考这里：https://github.com/Netflix/exhibitor/wiki/Building-Exhibitor，也可以从这里下载已经编绎好的jar文件:文件:Exhibitor-war-1.0-jar-with-dependencies.zip，下载后要修改后缀为jar。&nbsp;</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"></p>
<h5 style="margin:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><a style="color:rgb(51,102,153);margin:0px;padding:0px;" name="t21"></a>运行</h5>
<p><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">&nbsp;java -jar &lt;path&gt;/exhibitor-xxx.jar -c file</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">Exhibitor自动创建配置文件，在web界面所做的配置更改都会保存到exhibitor.properties中。&nbsp;</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"></p>
<h5 style="margin:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><a style="color:rgb(51,102,153);margin:0px;padding:0px;" name="t22"></a>配置项</h5>
<p><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">参考：https://github.com/Netflix/exhibitor/wiki/Configuration-UI&nbsp;</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">在配置“Servers”参数时，一定要注意要配置的是hostname，而不是IP。所以如果配置的是IP的话，一定要到目标机器上去检查hostname和IP是否一致。&nbsp;</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"></p>
<h5 style="margin:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><a style="color:rgb(51,102,153);margin:0px;padding:0px;" name="t23"></a>注意事项&nbsp;</h5>
<p><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">Exhibitor通过jps命令来判断Zookeeper服务是否运行，所以要配置好jps命令，如果没有当前没有jps命令的话，可以通过类似如下的命令创建一个软链接：</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">&nbsp;ls -s /home/www/jdk/jdk1.7.0_15/bin/jps /usr/bin/jps</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">&nbsp;Exhibitor会自动创建并覆盖zookeeper的配置文件，所以要在Web界面上把Zookeeper的所有参数都配置，</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">&nbsp;否则如果Zookeeper被Exhibitor重启后，可以会出现因为配置有错误而无法启动的状况。</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">&nbsp;在“control panel”面板中，当显示绿色，则说明Zookeeper服务正常，可以对外服务，当显示黄色或者红色，</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">&nbsp;则Zookeeper不能对外提供服务（这个和Zookeeper进程是否存在，是两个概念，即使Zookeeper进程存在，也可能无法对外提供服务）。</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">&nbsp;Exhibitor会定时探测Zookeeper服务是否正常，但是时间间隔默认配置为0，这个会导致机器CPU被消耗。要在Web界面中配置好“Live Check (ms)”参数。</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">&nbsp;因为Exhibitor如果探测到Zookeeper服务没有启动，会自动启动Zookeeper进程，所以在升级Zookeeper之前，要先停掉Exhibitor。</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"></p>
<h3 style="margin:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><a style="color:rgb(51,102,153);margin:0px;padding:0px;" name="t24"></a>其它的一些东东：</h3>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><br></p>
<h4 style="margin:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><a style="color:rgb(51,102,153);margin:0px;padding:0px;" name="t25"></a>性能测试相关：</h4>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);">https://github.com/brownsys/zookeeper-benchmark<br>这个工具输出结果比较乱，不过用起来还不错。<br>&nbsp; &nbsp; mvn -DZooKeeperVersion=3.4.5 package<br>&nbsp; &nbsp; ./runBenchmark.sh &nbsp;test<br>然后在test文件夹下，会有生成的信息。主要在zk-benchmark.log这个文件里。</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><br></p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);">http://zookeeper.apache.org/doc/r3.4.5/zookeeperOver.html &nbsp;</p>
<p><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">http://wiki.apache.org/hadoop/ZooKeeper/ServiceLatencyOverview 自带的文档里有一点，不过貌似没更新过</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">http://wiki.apache.org/hadoop/ZooKeeper/ServiceLatencyOverview &nbsp; Hadoop里带的一个测试</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">https://ramcloud.stanford.edu/wiki/display/ramcloud/ZooKeeper+Performance&nbsp;</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;background-color:rgb(255,255,255);">http://rdc.taobao.com/team/jm/archives/1070 &nbsp;淘宝的一个测试</span><br style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"></p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;white-space:normal;background-color:rgb(255,255,255);"><br></p>
<p><br></p>
