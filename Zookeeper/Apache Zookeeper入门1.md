<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 15px; margin-left: 10px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; color: rgb(64, 64, 64); font-family: Verdana, Tahoma, Arial, sans-serif; font-size: 12px; line-height: 18px; text-align: left; background-color: rgb(255, 255, 255); "><strong style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; ">口水:</strong>Zookeeper是我目前接触过Apache开源系统中比较复杂的一个产品，要搞清楚这个东东里面的运作关系还真不是一时半会可以搞定的事，本人目前只略知皮毛之术。</p> 
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 15px; margin-left: 10px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; color: rgb(64, 64, 64); font-family: Verdana, Tahoma, Arial, sans-serif; font-size: 12px; line-height: 18px; text-align: left; background-color: rgb(255, 255, 255); "><strong style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; ">ZooKeeper 是什么？</strong></p> 
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 15px; margin-left: 10px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; color: rgb(64, 64, 64); font-family: Verdana, Tahoma, Arial, sans-serif; font-size: 12px; line-height: 18px; text-align: left; background-color: rgb(255, 255, 255); ">&nbsp; ZooKeeper 顾名思义 动物园管理员，他是拿来管<a target="_blank" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; color: rgb(0, 0, 0); font-weight: bold; text-decoration: none; " href="http://hadoop.apache.org/">大象(Hadoop)</a>&nbsp;、&nbsp;<a target="_blank" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; color: rgb(0, 0, 0); font-weight: bold; text-decoration: none; " href="http://hive.apache.org/">蜜蜂(Hive)</a>&nbsp;、<a target="_blank" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; color: rgb(0, 0, 0); font-weight: bold; text-decoration: none; " href="http://pig.apache.org/">&nbsp;小猪(Pig)</a>&nbsp; 的管理员， Apache Hbase和 Apache Solr 以及<a target="_blank" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; color: rgb(0, 0, 0); font-weight: bold; text-decoration: none; " href="http://sna-projects.com/sensei">LinkedIn sensei&nbsp;</a>&nbsp;等项目中都采用到了 Zookeeper。ZooKeeper是一个分布式的，开放源码的分布式应用程序协调服务，ZooKeeper是以<a target="_blank" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; color: rgb(0, 0, 0); font-weight: bold; text-decoration: none; " href="http://rdc.taobao.com/blog/cs/?p=261">Fast Paxos</a>算法为基础，实现同步服务，配置维护和命名服务等分布式应用。<br style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; "> &nbsp;</p> 
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 15px; margin-left: 10px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; color: rgb(64, 64, 64); font-family: Verdana, Tahoma, Arial, sans-serif; font-size: 12px; line-height: 18px; text-align: left; background-color: rgb(255, 255, 255); "><strong style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; ">ZooKeeper 如何工作？</strong></p> 
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 15px; margin-left: 10px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; color: rgb(64, 64, 64); font-family: Verdana, Tahoma, Arial, sans-serif; font-size: 12px; line-height: 18px; text-align: left; background-color: rgb(255, 255, 255); ">&nbsp; ZooKeeper是作为分布式应用建立更高层次的同步(synchronization)、配置管理 (configuration maintenance)、群组(groups)以及名称服务(naming)。在编程上，ZooKeeper设计很简单，所使用的数据模型风格很像文件系统的目录树结构，简单来说，有点类似windows中注册表的结构，有名称，有树节点，有Key(键)/Value(值)对的关系，可以看做一个树形结构的数据库，分布在不同的机器上做名称管理。</p> 
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 15px; margin-left: 10px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; color: rgb(64, 64, 64); font-family: Verdana, Tahoma, Arial, sans-serif; font-size: 12px; line-height: 18px; text-align: left; background-color: rgb(255, 255, 255); ">&nbsp;&nbsp; Zookeeper分为2个部分：服务器端和客户端，客户端只连接到整个ZooKeeper服务的某个服务器上。客户端使用并维护一个TCP连接，通过这个连接发送请求、接受响应、获取观察的事件以及发送心跳。如果这个TCP连接中断，客户端将尝试连接到另外的ZooKeeper服务器。客户端第一次连接到ZooKeeper服务时，接受这个连接的 ZooKeeper服务器会为这个客户端建立一个会话。当这个客户端连接到另外的服务器时，这个会话会被新的服务器重新建立。</p> 
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 15px; margin-left: 10px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; color: rgb(64, 64, 64); font-family: Verdana, Tahoma, Arial, sans-serif; font-size: 12px; line-height: 18px; text-align: left; background-color: rgb(255, 255, 255); ">&nbsp;&nbsp; 启动Zookeeper服务器集群环境后，多个Zookeeper服务器在工作前会选举出一个Leader，在接下来的工作中这个被选举出来的Leader死了，而剩下的Zookeeper服务器会知道这个Leader死掉了，在活着的Zookeeper集群中会继续选出一个Leader，选举出leader的目的是为了可以在分布式的环境中保证数据的一致性。如图所示：<br style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; "> <a target="_blank" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; color: rgb(0, 0, 0); font-weight: bold; text-decoration: none; " href="http://niaklq.bay.livefilestore.com/y1pbARJq1ijQRd1v-pIceq9GqFvcw6FjLE7bGM59B8FAidzR_goQ5z23rLkXdoGFVyES43s3c_lYp8DHVna89l6wx_e4cxii8aP/zookeeper-blog-1.jpg?psid=1"><img onload="if(this.width>650) this.width=650;" alt="" height="235" width="600" style="margin-top: 5px; margin-right: 5px; margin-bottom: 5px; margin-left: 5px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; " src="http://niaklq.bay.livefilestore.com/y1pbARJq1ijQRd1v-pIceq9GqFvcw6FjLE7a7A60fTl07AbpaOJcT8aZ7NLnwWtVnCA-injs7P8s9lp4GoUZiTjUq3hkhuiBPVq/zookeeper-blog-1.jpg?psid=1"></a></p> 
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 15px; margin-left: 10px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; color: rgb(64, 64, 64); font-family: Verdana, Tahoma, Arial, sans-serif; font-size: 12px; line-height: 18px; text-align: left; background-color: rgb(255, 255, 255); ">&nbsp; 另外，ZooKeeper 支持watch(观察)的概念。客户端可以在每个znode结点上设置一个观察。如果被观察服务端的znode结点有变更，那么watch就会被触发，这个watch所属的客户端将接收到一个通知包被告知结点已经发生变化。若客户端和所连接的ZooKeeper服务器断开连接时，其他客户端也会收到一个通知，也就说一个Zookeeper服务器端可以对于多个客户端，当然也可以多个Zookeeper服务器端可以对于多个客户端，如图所示：<br style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; "> <a target="_blank" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; color: rgb(0, 0, 0); font-weight: bold; text-decoration: none; " href="http://niaklq.bay.livefilestore.com/y1pIeYJau1gfAywPWxuBGKiLDdRjr9O2gRWMJyCZf5mP4RyugNPZGhEzJRQg-GV2j2zSZao92O_YXAeVESTKqM4sjiq9FdCaUUr/zookeeper-blog-2.jpg?psid=1"><img onload="if(this.width>650) this.width=650;" alt="" style="margin-top: 5px; margin-right: 5px; margin-bottom: 5px; margin-left: 5px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; width: 486px; height: 487px; " src="http://niaklq.bay.livefilestore.com/y1pIeYJau1gfAywPWxuBGKiLDdRjr9O2gRWs_IWlgbdgjNTh2ne_nC2bnlsu47cW5vPICFgY_6uC6uqtplg-eJ8iFY-cImbaiTB/zookeeper-blog-2.jpg?psid=1"></a></p> 
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 15px; margin-left: 10px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; color: rgb(64, 64, 64); font-family: Verdana, Tahoma, Arial, sans-serif; font-size: 12px; line-height: 18px; text-align: left; background-color: rgb(255, 255, 255); ">你还可以通过命令查看出，当前那个Zookeeper服务端的节点是Leader，哪个是Follower，如图所示：<br style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; "> <a target="_blank" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; color: rgb(0, 0, 0); font-weight: bold; text-decoration: none; " href="http://niaklq.bay.livefilestore.com/y1p2oHPXOPJ-U760tUrelzMf-yqtDd46Jl2c-yjOfnFsjQ0y8wH6gTt0JHx80y5Aha3UyAqhNOtECfJyrDYNGiR194G7bH52Gl-/zookeeper-node-list.jpg?psid=1"><img onload="if(this.width>650) this.width=650;" alt="" height="450" width="532" style="margin-top: 5px; margin-right: 5px; margin-bottom: 5px; margin-left: 5px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; " src="http://niaklq.bay.livefilestore.com/y1pdfZzMgjmaeK7lxHpgzjtCzqHyAMRX3jl9F1NfvNfjkfuor_7kngjci9W5QYmEhZquWGnXPdoprtQCiSpDvm3z3zyIWO9zTK5/zookeeper-node-list.jpg?psid=1"></a></p> 
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 15px; margin-left: 10px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; color: rgb(64, 64, 64); font-family: Verdana, Tahoma, Arial, sans-serif; font-size: 12px; line-height: 18px; text-align: left; background-color: rgb(255, 255, 255); ">我通过试验观察到 Zookeeper的集群环境最好有3台以上的节点，如果只有2台，那么2台当中不管那台机器down掉，将只会剩下一个leader，那么如果有再有客户端连接上来，将无法工作，并且剩下的leader服务器会不断的抛出异常。内容如下：<br style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; "> java.net.ConnectException: Connection refused<br style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; "> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at sun.nio.ch.Net.connect(Native Method)<br style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; "> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at sun.nio.ch.SocketChannelImpl.connect(SocketChannelImpl.java:507)<br style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; "> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at java.nio.channels.SocketChannel.open(SocketChannel.java:146)<br style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; "> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at org.apache.zookeeper.server.quorum.QuorumCnxManager.connectOne(QuorumCnxManager.java:347)<br style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; "> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at org.apache.zookeeper.server.quorum.QuorumCnxManager.connectAll(QuorumCnxManager.java:381)<br style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; "> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at org.apache.zookeeper.server.quorum.FastLeaderElection.lookForLeader(FastLeaderElection.java:674)<br style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; "> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at org.apache.zookeeper.server.quorum.QuorumPeer.run(QuorumPeer.java:611)<br style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; "> 2010-11-15 00:31:52,031 &#x2013; INFO&nbsp; [QuorumPeer:/0:0:0:0:0:0:0:0:2181:FastLeaderElection@683] &#x2013; Notification time out: 12800</p> 
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 15px; margin-left: 10px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; color: rgb(64, 64, 64); font-family: Verdana, Tahoma, Arial, sans-serif; font-size: 12px; line-height: 18px; text-align: left; background-color: rgb(255, 255, 255); ">并且客户端连接时还会抛出这样的异常，说明连接被拒绝，并且等待一个socket连接新的连接，这里socket新的连接指的是zookeeper中的一个Follower。<br style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; "> org.apache.zookeeper.ClientCnxn$SendThread.startConnect(ClientCnxn.java:1000) Opening socket connection to server 192.168.50.211/192.168.50.211:2181&nbsp;&nbsp;<br style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; "> org.apache.zookeeper.ClientCnxn$SendThread.primeConnection(ClientCnxn.java:908) Socket connection established to 192.168.50.211/192.168.50.211:2181, initiating session&nbsp;&nbsp;<br style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; "> org.apache.zookeeper.ClientCnxn$SendThread.run(ClientCnxn.java:1118) Unable to read additional data from server sessionid 0×0, likely server has closed socket, closing socket connection and attempting reconnect&nbsp;&nbsp;<br style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; "> org.apache.zookeeper.ClientCnxn$SendThread.startConnect(ClientCnxn.java:1000) Opening socket connection to server localhost/127.0.0.1:2181&nbsp;&nbsp;<br style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; "> &nbsp;2010-11-15 13:31:56,626 WARN&nbsp;&nbsp; org.apache.zookeeper.ClientCnxn$SendThread.run(ClientCnxn.java:1120) Session 0×0 for server null, unexpected error, closing socket connection and attempting reconnect&nbsp;&nbsp;<br style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; "> &nbsp;</p> 
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 15px; margin-left: 10px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; color: rgb(64, 64, 64); font-family: Verdana, Tahoma, Arial, sans-serif; font-size: 12px; line-height: 18px; text-align: left; background-color: rgb(255, 255, 255); ">&nbsp;先写到这里，全面了解Zookeeper不太容易，光看Apache Zookeeper官方的wiki和文档还不能对其有深入的了解，想阅读Zookeeper中的部分源代码。另外，本人目前正在学习和了解ing，欢迎大家与我交流，谢谢。</p> 
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 15px; margin-left: 10px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; color: rgb(64, 64, 64); font-family: Verdana, Tahoma, Arial, sans-serif; font-size: 12px; line-height: 18px; text-align: left; background-color: rgb(255, 255, 255); ">&nbsp;</p> 
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 15px; margin-left: 10px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; color: rgb(64, 64, 64); font-family: Verdana, Tahoma, Arial, sans-serif; font-size: 12px; line-height: 18px; text-align: left; background-color: rgb(255, 255, 255); "><span style="font-size: 16px; ">原文：</span><a style="font-family: Simsun; line-height: normal; text-align: -webkit-auto; font-size: medium; " href="http://www.javabloger.com/article/apache-zookeeper-hadoop.html"><span style="font-size: 16px; ">http://www.javabloger.com/article/apache-zookeeper-hadoop.html</span></a></p>
