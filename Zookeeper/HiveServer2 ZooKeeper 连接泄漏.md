<p style="text-indent:24px;"><span style="font-size:13px;font-family:'宋体';">昨天线上</span><span style="font-size:13px;font-family:consolas;">ETLJob</span><span style="font-size:13px;font-family:'宋体';">突然挂起，查看</span><span style="font-size:13px;font-family:consolas;">Hive Log</span><span style="font-size:13px;font-family:'宋体';">异常：</span></p>
<p style="text-indent:24px;"><span style="font-size:13px;font-family:consolas;">[ERROR]:Utils - FAILED: Error in acquiring locks: Locks on the underlying objectscannot be acquired. retry after some time</span></p>
<p style="text-indent:24px;"><span style="font-size:13px;font-family:consolas;">WARNunexpected error, closing socket connection and attempting reconnectjava.io.IOException: Connection reset by peer</span></p>
<p style="text-indent:24px;"><span style="font-size:13px;font-family:'宋体';">一看是获取锁失败，关于</span><span style="font-size:13px;font-family:consolas;">Hive</span><span style="font-size:13px;font-family:'宋体';">获取锁的流程简析：</span></p>
<p style="text-indent:24px;"><a href="http://boylook.blog.51cto.com/7934327/1308139" target="_blank">http://boylook.blog.51cto.com/7934327/1308139</a></p>
<p style="text-indent:24px;"><span style="font-size:13px;font-family:'宋体';">在看</span><span style="font-size:13px;font-family:consolas;">ZK</span><span style="font-size:13px;font-family:'宋体';">发现从这台</span><span style="font-size:13px;font-family:consolas;">Agent</span><span style="font-size:13px;font-family:'宋体';">到</span><span style="font-size:13px;font-family:consolas;">ZK</span><span style="font-size:13px;font-family:'宋体';">的连接已经超过</span><span style="font-size:13px;font-family:consolas;">maxClientCnxns</span><span style="font-size:13px;font-family:'宋体';">了，立刻先把</span><span style="font-size:13px;font-family:consolas;">ZK</span><span style="font-size:13px;font-family:'宋体';">增加问题得到缓解，然后开始找</span><span style="font-size:13px;font-family:consolas;">RC</span><span style="font-size:13px;font-family:'宋体';">：</span></p>
<p style="text-indent:24px;"><span style="font-size:13px;font-family:'宋体';">出现问题的前一天修改了</span><span style="font-size:13px;font-family:consolas;">hive.lock.sleep.between.retries</span><span style="font-size:13px;font-family:'宋体';">到</span><span style="font-size:13px;font-family:consolas;">5s</span><span style="font-size:13px;font-family:'宋体';">，是不是和这个有关系呢？每次</span><span style="font-size:13px;font-family:consolas;">ZKLockManager</span><span style="font-size:13px;font-family:'宋体';">在</span><span style="font-size:13px;font-family:consolas;">retry</span><span style="font-size:13px;font-family:'宋体';">前会执行</span><span style="font-size:13px;font-family:consolas;">prepareretry</span><span style="font-size:13px;font-family:'宋体';">，主要是检查前一个</span><span style="font-size:13px;font-family:consolas;">zk</span><span style="font-size:13px;font-family:'宋体';">连接是否超时，如果没有继续用这个连接否则</span><span style="font-size:13px;font-family:consolas;">new</span><span style="font-size:13px;font-family:'宋体';">一个</span><span style="font-size:13px;font-family:consolas;">zk</span><span style="font-size:13px;font-family:'宋体';">连接，因此问题不应该是这里</span><span style="font-size:13px;font-family:consolas;">.</span></p>
<p style="text-indent:24px;"><span style="font-size:13px;font-family:'宋体';">再看出问题的</span><span style="font-size:13px;font-family:consolas;">Client</span><span style="font-size:13px;font-family:'宋体';">上主要跑了</span><span style="font-size:13px;font-family:consolas;">ETL agent</span><span style="font-size:13px;font-family:'宋体';">和</span><span style="font-size:13px;font-family:consolas;">hiveserver2</span><span style="font-size:13px;font-family:'宋体';">，发现连接都是从</span><span style="font-size:13px;font-family:consolas;">hiveserver2</span><span style="font-size:13px;font-family:'宋体';">上来的，怀疑是不是因为默认的</span><span style="font-size:13px;font-family:consolas;">maxWorkerThreads</span><span style="font-size:13px;font-family:'宋体';">略大了，不过</span><span style="font-size:13px;font-family:consolas;">worker</span><span style="font-size:13px;font-family:'宋体';">和</span><span style="font-size:13px;font-family:consolas;">zk</span><span style="font-size:13px;font-family:'宋体';">的连接无关，只是决定了</span><span style="font-size:13px;font-family:consolas;">ThreadPoolExecutor</span><span style="font-size:13px;font-family:'宋体';">的线程数，看</span><span style="font-size:13px;font-family:consolas;">hiveserver</span><span style="font-size:13px;font-family:'宋体';">部分代码最终与</span><span style="font-size:13px;font-family:consolas;">ZK</span><span style="font-size:13px;font-family:'宋体';">交互的执行层面是</span><span style="font-size:13px;font-family:consolas;">OperationHandle</span><span style="font-size:13px;font-family:'宋体';">，进而就是大家都熟悉的</span><span style="font-size:13px;font-family:consolas;">Driver run</span><span style="font-size:13px;font-family:'宋体';">方法了，到这里基本上才开始进行</span><span style="font-size:13px;font-family:consolas;">SQL</span><span style="font-size:13px;font-family:'宋体';">的解析运行，包括锁的处理</span><span style="font-size:13px;font-family:consolas;">.</span></p>
<p style="text-indent:24px;"><span style="font-size:13px;font-family:consolas;"><a href="http://img1.51cto.com/attachment/201310/210246344.png" target="_blank"><img onload="if(this.width>650) this.width=650;" src="http://img1.51cto.com/attachment/201310/210246344.png" title="还.png" alt="210246344.png"></a></span></p>
<p style="text-indent:24px;"><span style="font-size:13px;font-family:'宋体';">而我们使用的是</span><span style="font-size:13px;font-family:consolas;">CDH4.2.0</span><span style="font-size:13px;font-family:'宋体';">，这里有一个</span><span style="font-size:13px;font-family:consolas;">OperationHandle </span><span style="font-size:13px;font-family:'宋体';">资源泄露进而导致到</span><span style="font-size:13px;font-family:consolas;">ZK</span><span style="font-size:13px;font-family:'宋体';">连接泄漏的一个</span><span style="font-size:13px;font-family:consolas;">Bug</span><span style="font-size:13px;font-family:'宋体';">：</span></p>
<p style="text-indent:24px;"><a href="https://issues.cloudera.org/browse/DISTRO-512?page=com.atlassian.jira.plugin.system.issuetabpanels%3Aall-tabpanel#issue-tabs" target="_blank">https://issues.cloudera.org/browse/DISTRO-512?page=com.atlassian.jira.plugin.system.issuetabpanels%3Aall-tabpanel#issue-tabs</a>&#xfffd;&gt; <span style="font-size:13px;font-family:consolas;">HIVE-4398</span><span style="font-size:13px;font-family:'宋体';">，在</span><span style="font-size:13px;font-family:consolas;">Hive0.11</span><span style="font-size:13px;font-family:'宋体';">已经修复</span></p>
<p style="text-indent:24px;"><span style="font-size:13px;font-family:'宋体';">update:<a href="https://issues.apache.org/jira/browse/HIVE-5853" style="font-family:'宋体';font-size:13px;text-indent:24px;">https://issues.apache.org/jira/browse/HIVE-5853</a></span></p>
<p><br></p>
<p>本文出自 “<a href="http://boylook.blog.51cto.com">MIKE老毕的海贼船</a>” 博客，请务必保留此出处<a href="http://boylook.blog.51cto.com/7934327/1315751">http://boylook.blog.51cto.com/7934327/1315751</a></p>
