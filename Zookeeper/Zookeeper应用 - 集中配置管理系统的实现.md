<p>出处：<a href="http://www.open-open.com/lib/view/open1403402321312.html" target="_blank">http://www.open-open.com/lib/view/open1403402321312.html</a> </p>
<p><br></p>
<p><strong><span style="font-family:'宋体';">大型网站架构交流</span></strong><strong>QQ</strong><strong><span style="font-family:'宋体';">群：</span></strong><strong>466097527 </strong><strong><span style="font-family:'宋体';">每周技术分享</span></strong><strong> </strong><strong><span style="font-family:'宋体';">经典电子书分享</span></strong><strong> </strong><strong><span style="font-family:'宋体';">欢迎加群</span></strong></p>
<p><strong><span style="font-family:'宋体';"><br></span></strong></p>
<p><span style="padding:0px;margin:0px;line-height:25.2000007629395px;color:rgb(64,64,64);font-family:'Microsoft YaHei', Verdana, sans-serif, SimSun;font-size:14px;background-color:rgb(250,250,250);">一个带配置的服务程序，部署在若干台机器上，如果配置发生了变化，接下去要进行的操作是停止所有机器上的该程序，修改每一台机器上该程序对应的配置文件。 这个情景会有两个问题：第一，机器多了，逐个修改配置是一件不合理的运维；第二，配置一般是程序启动时读入的，所以配置修改后，程序应该重启。 配置管理在某些场合称“数据发布与订阅”，顾名思义就是将数据发布到zk节点上，供订阅者动态获取数据，实现配置信息的集中式管理和动态更新。例如全局的配置信息，地址列表等就非常适合使用。</span><span style="color:rgb(64,64,64);font-family:'Microsoft YaHei', Verdana, sans-serif, SimSun;font-size:14px;line-height:25.2000007629395px;background-color:rgb(250,250,250);"></span></p>
<h1 style="padding:0px;margin:5px auto;font-size:14px;color:rgb(64,64,64);font-family:'Microsoft YaHei', Verdana, sans-serif, SimSun;line-height:25.2000007629395px;white-space:normal;background-color:rgb(250,250,250);">1&nbsp;<span style="padding:0px;margin:0px;line-height:25.2000007629395px;font-family:'宋体';">场景描述</span></h1>
<p style="padding:0px;margin-top:10px;margin-bottom:10px;line-height:25.2000007629395px;color:rgb(51,51,51);font-size:14px;white-space:normal;font-family:Arial;background-color:rgb(255,255,255);">参考<a href="http://www.ibm.com/developerworks/cn/opensource/os-cn-zookeeper/index.html" style="padding:0px;margin:0px;text-decoration:none;color:rgb(0,95,169);" target="_blank">http://www.ibm.com/developerworks/cn/opensource/os-cn-zookeeper/index.html</a>，实现自己的集中配置管理系统。</p>
<p style="padding:0px;margin-top:10px;margin-bottom:10px;line-height:25.2000007629395px;color:rgb(51,51,51);font-size:14px;white-space:normal;font-family:Arial;background-color:rgb(255,255,255);">术语：配置管理（<span style="padding:0px;margin:0px;line-height:25.2000007629395px;color:rgb(64,64,64);font-family:'Times New Roman';">Configuration&nbsp;Management</span><span style="padding:0px;margin:0px;line-height:25.2000007629395px;color:rgb(64,64,64);font-family:'宋体';">）</span></p>
<p style="padding:0px;margin-top:10px;margin-bottom:10px;line-height:25.2000007629395px;color:rgb(51,51,51);font-size:14px;white-space:normal;font-family:Arial;background-color:rgb(255,255,255);">一个带配置的服务程序，部署在若干台机器上，如果配置发生了变化，接下去要进行的操作是停止所有机器上的该程序，修改每一台机器上该程序对应的配置文件。</p>
<p style="padding:0px;margin-top:10px;margin-bottom:10px;line-height:25.2000007629395px;color:rgb(51,51,51);font-size:14px;white-space:normal;font-family:Arial;background-color:rgb(255,255,255);">这个情景会有两个问题：第一，机器多了，逐个修改配置是一件不合理的运维；第二，配置一般是程序启动时读入的，所以配置修改后，程序应该重启。</p>
<p style="padding:0px;margin-top:10px;margin-bottom:10px;line-height:25.2000007629395px;color:rgb(51,51,51);font-size:14px;white-space:normal;font-family:Arial;background-color:rgb(255,255,255);">配置管理在某些场合称“数据发布与订阅”，顾名思义就是将数据发布到<span style="padding:0px;margin:0px;line-height:25.2000007629395px;color:rgb(64,64,64);font-family:'Times New Roman';">zk</span><span style="padding:0px;margin:0px;line-height:25.2000007629395px;color:rgb(64,64,64);font-family:'宋体';">节点上，供订阅者动态获取数据，实现配置信息的集中式管理和动态更新。例如全局的配置信息，地址列表等就非常适合使用。</span></p>
<p style="padding:0px;margin-top:10px;margin-bottom:10px;line-height:25.2000007629395px;color:rgb(51,51,51);font-size:14px;white-space:normal;font-family:Arial;background-color:rgb(255,255,255);">实际应用环境：</p>
<p style="padding:0px;margin-top:10px;margin-bottom:10px;line-height:25.2000007629395px;color:rgb(51,51,51);font-size:14px;white-space:normal;font-family:Arial;background-color:rgb(255,255,255);">1.&nbsp;<span style="padding:0px;margin:0px;line-height:25.2000007629395px;color:rgb(64,64,64);font-family:'宋体';">索引信息和集群中机器节点状态存放在</span><span style="padding:0px;margin:0px;line-height:25.2000007629395px;color:rgb(64,64,64);font-family:'Times New Roman';">zk</span><span style="padding:0px;margin:0px;line-height:25.2000007629395px;color:rgb(64,64,64);font-family:'宋体';">的一些指定节点，供各个客户端订阅使用。</span>&nbsp;2.&nbsp;<span style="padding:0px;margin:0px;line-height:25.2000007629395px;color:rgb(64,64,64);font-family:'宋体';">系统日志（经过处理后的）存储，这些日志通常</span><span style="padding:0px;margin:0px;line-height:25.2000007629395px;color:rgb(64,64,64);font-family:'Times New Roman';">2-3</span><span style="padding:0px;margin:0px;line-height:25.2000007629395px;color:rgb(64,64,64);font-family:'宋体';">天后被清除。&nbsp;</span></p>
<p style="padding:0px;margin-top:10px;margin-bottom:10px;line-height:25.2000007629395px;color:rgb(51,51,51);font-size:14px;white-space:normal;font-family:Arial;background-color:rgb(255,255,255);">3.&nbsp;<span style="padding:0px;margin:0px;line-height:25.2000007629395px;color:rgb(64,64,64);font-family:'宋体';">应用中用到的一些配置信息集中管理，在应用启动的时候主动来获取一次，并且在节点上注册一个</span><span style="padding:0px;margin:0px;line-height:25.2000007629395px;color:rgb(64,64,64);font-family:'Times New Roman';">Watcher</span><span style="padding:0px;margin:0px;line-height:25.2000007629395px;color:rgb(64,64,64);font-family:'宋体';">，以后每次配置有更新，实时通知到应用，获取最新配置信息。</span></p>
<p style="padding:0px;margin-top:10px;margin-bottom:10px;line-height:25.2000007629395px;color:rgb(51,51,51);font-size:14px;white-space:normal;font-family:Arial;background-color:rgb(255,255,255);">4.&nbsp;<span style="padding:0px;margin:0px;line-height:25.2000007629395px;color:rgb(64,64,64);font-family:'宋体';">业务逻辑中需要用到的一些全局变量，比如一些消息中间件的消息队列通常有个</span><span style="padding:0px;margin:0px;line-height:25.2000007629395px;color:rgb(64,64,64);font-family:'Times New Roman';">offset</span><span style="padding:0px;margin:0px;line-height:25.2000007629395px;color:rgb(64,64,64);font-family:'宋体';">，这个</span><span style="padding:0px;margin:0px;line-height:25.2000007629395px;color:rgb(64,64,64);font-family:'Times New Roman';">offset</span><span style="padding:0px;margin:0px;line-height:25.2000007629395px;color:rgb(64,64,64);font-family:'宋体';">存放在</span><span style="padding:0px;margin:0px;line-height:25.2000007629395px;color:rgb(64,64,64);font-family:'Times New Roman';">zk</span><span style="padding:0px;margin:0px;line-height:25.2000007629395px;color:rgb(64,64,64);font-family:'宋体';">上，这样集群中每个发送者都能知道当前的发送进度。</span></p>
<p style="padding:0px;margin-top:10px;margin-bottom:10px;line-height:25.2000007629395px;color:rgb(51,51,51);font-size:14px;white-space:normal;font-family:Arial;background-color:rgb(255,255,255);">5.&nbsp;<span style="padding:0px;margin:0px;line-height:25.2000007629395px;color:rgb(64,64,64);font-family:'宋体';">系统中有些信息需要动态获取，并且还会存在人工手动去修改这个信息。以前通常是暴露出接口，例如</span><span style="padding:0px;margin:0px;line-height:25.2000007629395px;color:rgb(64,64,64);font-family:'Times New Roman';">JMX</span><span style="padding:0px;margin:0px;line-height:25.2000007629395px;color:rgb(64,64,64);font-family:'宋体';">接口，有了</span><span style="padding:0px;margin:0px;line-height:25.2000007629395px;color:rgb(64,64,64);font-family:'Times New Roman';">zk</span><span style="padding:0px;margin:0px;line-height:25.2000007629395px;color:rgb(64,64,64);font-family:'宋体';">后，只要将这些信息存放到</span><span style="padding:0px;margin:0px;line-height:25.2000007629395px;color:rgb(64,64,64);font-family:'Times New Roman';">zk</span><span style="padding:0px;margin:0px;line-height:25.2000007629395px;color:rgb(64,64,64);font-family:'宋体';">节点上即可。</span></p>
<h1 style="padding:0px;margin:5px auto;font-size:14px;color:rgb(64,64,64);font-family:'Microsoft YaHei', Verdana, sans-serif, SimSun;line-height:25.2000007629395px;white-space:normal;background-color:rgb(250,250,250);">2&nbsp;<span style="padding:0px;margin:0px;line-height:25.2000007629395px;font-family:'宋体';">需求概括</span></h1>
<p style="padding:0px;margin-top:10px;margin-bottom:10px;line-height:25.2000007629395px;color:rgb(51,51,51);font-size:14px;white-space:normal;font-family:Arial;background-color:rgb(255,255,255);">a）解决服务程序统一配置的问题；</p>
<p style="padding:0px;margin-top:10px;margin-bottom:10px;line-height:25.2000007629395px;color:rgb(51,51,51);font-size:14px;white-space:normal;font-family:Arial;background-color:rgb(255,255,255);">b）解决服务配置更改的热加载问题；（热加载：程序更改配置，不需重启就能快速响应）</p>
<h1 style="padding:0px;margin:5px auto;font-size:14px;color:rgb(64,64,64);font-family:'Microsoft YaHei', Verdana, sans-serif, SimSun;line-height:25.2000007629395px;white-space:normal;background-color:rgb(250,250,250);">3&nbsp;<span style="padding:0px;margin:0px;line-height:25.2000007629395px;font-family:'宋体';">技术原理</span></h1>
<p style="padding:0px;margin-top:10px;margin-bottom:10px;line-height:25.2000007629395px;color:rgb(51,51,51);font-size:14px;white-space:normal;font-family:Arial;background-color:rgb(255,255,255);">利用<span style="padding:0px;margin:0px;line-height:25.2000007629395px;color:rgb(64,64,64);font-family:'Times New Roman';">zookeeper</span><span style="padding:0px;margin:0px;line-height:25.2000007629395px;color:rgb(64,64,64);font-family:'宋体';">的特性（略），</span>将配置信息保存在&nbsp;<span style="padding:0px;margin:0px;line-height:25.2000007629395px;color:rgb(64,64,64);font-family:'Times New Roman';">Zookeeper&nbsp;</span><span style="padding:0px;margin:0px;line-height:25.2000007629395px;color:rgb(64,64,64);font-family:'宋体';">的某个目录节点中，然后将所有需要修改的应用机器监控配置信息的状态，一旦配置信息发生变化，每台应用机器就会收到&nbsp;</span><span style="padding:0px;margin:0px;line-height:25.2000007629395px;color:rgb(64,64,64);font-family:'Times New Roman';">Zookeeper&nbsp;</span><span style="padding:0px;margin:0px;line-height:25.2000007629395px;color:rgb(64,64,64);font-family:'宋体';">的通知，然后从&nbsp;</span><span style="padding:0px;margin:0px;line-height:25.2000007629395px;color:rgb(64,64,64);font-family:'Times New Roman';">Zookeeper&nbsp;</span><span style="padding:0px;margin:0px;line-height:25.2000007629395px;color:rgb(64,64,64);font-family:'宋体';">获取新的配置信息应用到系统中。</span></p>
<p style="padding:0px;margin-top:10px;margin-bottom:10px;line-height:25.2000007629395px;color:rgb(51,51,51);font-size:14px;white-space:normal;font-family:Arial;background-color:rgb(255,255,255);">a）znode<span style="padding:0px;margin:0px;line-height:25.2000007629395px;color:rgb(64,64,64);font-family:'宋体';">的路径作为配置项能做到全局唯一；</span></p>
<p style="padding:0px;margin-top:10px;margin-bottom:10px;line-height:25.2000007629395px;color:rgb(51,51,51);font-size:14px;white-space:normal;font-family:Arial;background-color:rgb(255,255,255);">b）znode<span style="padding:0px;margin:0px;line-height:25.2000007629395px;color:rgb(64,64,64);font-family:'宋体';">的内容作为配置项的值，始终存在与内存中，方便读取；</span></p>
<p style="padding:0px;margin-top:10px;margin-bottom:10px;line-height:25.2000007629395px;color:rgb(51,51,51);font-size:14px;white-space:normal;font-family:Arial;background-color:rgb(255,255,255);">c）znode<span style="padding:0px;margin:0px;line-height:25.2000007629395px;color:rgb(64,64,64);font-family:'宋体';">的权限作为项目之间的配置隔离机制，可以做到项目配置的安全管理；</span></p>
<p style="padding:0px;margin-top:10px;margin-bottom:10px;line-height:25.2000007629395px;color:rgb(51,51,51);font-size:14px;white-space:normal;font-family:Arial;background-color:rgb(255,255,255);">zookeeper<span style="padding:0px;margin:0px;line-height:25.2000007629395px;color:rgb(64,64,64);font-family:'宋体';">拥有的特性使得配置的存储、读取、监听（</span><span style="padding:0px;margin:0px;line-height:25.2000007629395px;color:rgb(64,64,64);font-family:'Times New Roman';">watch</span><span style="padding:0px;margin:0px;line-height:25.2000007629395px;color:rgb(64,64,64);font-family:'宋体';">）等都很好地实现，我们所需要做的事情――</span><span style="padding:0px;margin:0px;line-height:25.2000007629395px;color:rgb(64,64,64);">开发一个统一的控制终端以及提供程序读取配置的接口。</span></p>
<p style="padding:0px;margin-top:10px;margin-bottom:10px;line-height:25.2000007629395px;color:rgb(51,51,51);font-size:14px;white-space:normal;font-family:Arial;background-color:rgb(255,255,255);"><span style="padding:0px;margin:0px;line-height:25.2000007629395px;color:rgb(64,64,64);">a）</span><span style="padding:0px;margin:0px;line-height:25.2000007629395px;color:rgb(64,64,64);">集中的Web<span style="padding:0px;margin:0px;line-height:25.2000007629395px;font-family:'宋体';">控制终端</span></span><span style="padding:0px;margin:0px;line-height:25.2000007629395px;color:rgb(64,64,64);">：</span><span style="padding:0px;margin:0px;line-height:25.2000007629395px;color:rgb(64,64,64);">包含配置信息增加、删除、修改、查询、部署等等</span><span style="padding:0px;margin:0px;line-height:25.2000007629395px;color:rgb(64,64,64);">；</span></p>
<p style="padding:0px;margin-top:10px;margin-bottom:10px;line-height:25.2000007629395px;color:rgb(51,51,51);font-size:14px;white-space:normal;font-family:Arial;background-color:rgb(255,255,255);"><span style="padding:0px;margin:0px;line-height:25.2000007629395px;color:rgb(64,64,64);">b）</span><span style="padding:0px;margin:0px;line-height:25.2000007629395px;color:rgb(64,64,64);">Java<span style="padding:0px;margin:0px;line-height:25.2000007629395px;font-family:'宋体';">读取配置项的类和接口；</span></span></p>
<p style="padding:0px;margin-top:10px;margin-bottom:10px;line-height:25.2000007629395px;color:rgb(51,51,51);font-size:14px;white-space:normal;font-family:Arial;background-color:rgb(255,255,255);"><span style="padding:0px;margin:0px;line-height:25.2000007629395px;color:rgb(64,64,64);">c）</span><span style="padding:0px;margin:0px;line-height:25.2000007629395px;color:rgb(64,64,64);">C++<span style="padding:0px;margin:0px;line-height:25.2000007629395px;font-family:'宋体';">读取配置的类和接口；</span></span></p>
<h1 style="padding:0px;margin:5px auto;font-size:14px;color:rgb(64,64,64);font-family:'Microsoft YaHei', Verdana, sans-serif, SimSun;line-height:25.2000007629395px;white-space:normal;background-color:rgb(250,250,250);">4&nbsp;<span style="padding:0px;margin:0px;line-height:25.2000007629395px;font-family:'宋体';">体系结构</span></h1>
<p style="padding:0px;margin-top:10px;margin-bottom:10px;line-height:25.2000007629395px;color:rgb(51,51,51);font-size:14px;white-space:normal;font-family:Arial;background-color:rgb(255,255,255);"><img onload="if(this.width>650) this.width=650;" alt="Zookeeper应用――集中配置管理系统的实现" src="http://static.open-open.com/lib/uploadImg/20140622/20140622095832_140.jpg" width="608" height="360" style="padding:0px;margin:0px;border:0px;"></p>
<h1 style="padding:0px;margin:5px auto;font-size:14px;color:rgb(64,64,64);font-family:'Microsoft YaHei', Verdana, sans-serif, SimSun;line-height:25.2000007629395px;white-space:normal;background-color:rgb(250,250,250);">5&nbsp;<span style="padding:0px;margin:0px;line-height:25.2000007629395px;font-family:'宋体';">配置存储结构</span></h1>
<p style="padding:0px;margin-top:10px;margin-bottom:10px;line-height:25.2000007629395px;color:rgb(51,51,51);font-size:14px;white-space:normal;font-family:Arial;background-color:rgb(255,255,255);"><img onload="if(this.width>650) this.width=650;" alt="Zookeeper应用――集中配置管理系统的实现" src="http://static.open-open.com/lib/uploadImg/20140622/20140622095832_524.jpg" width="583" height="233" style="padding:0px;margin:0px;border:0px;"></p>
<p style="padding:0px;margin-top:10px;margin-bottom:10px;line-height:25.2000007629395px;color:rgb(51,51,51);font-size:14px;white-space:normal;font-family:Arial;background-color:rgb(255,255,255);"><span style="padding:0px;margin:0px;line-height:25.2000007629395px;color:rgb(64,64,64);background:rgb(255,255,0);">3&nbsp;<span style="padding:0px;margin:0px;line-height:25.2000007629395px;font-family:'宋体';">层，存</span><span style="padding:0px;margin:0px;line-height:25.2000007629395px;font-family:'Times New Roman';">xml</span><span style="padding:0px;margin:0px;line-height:25.2000007629395px;font-family:'宋体';">文件的字符串。</span></span></p>
<h1 style="padding:0px;margin:5px auto;font-size:14px;color:rgb(64,64,64);font-family:'Microsoft YaHei', Verdana, sans-serif, SimSun;line-height:25.2000007629395px;white-space:normal;background-color:rgb(250,250,250);">5&nbsp;<span style="padding:0px;margin:0px;line-height:25.2000007629395px;font-family:'宋体';">优势</span></h1>
<p style="padding:0px;margin-top:10px;margin-bottom:10px;line-height:25.2000007629395px;color:rgb(51,51,51);font-size:14px;white-space:normal;font-family:Arial;background-color:rgb(255,255,255);">a）配置统一管理，方便运维；</p>
<p style="padding:0px;margin-top:10px;margin-bottom:10px;line-height:25.2000007629395px;color:rgb(51,51,51);font-size:14px;white-space:normal;font-family:Arial;background-color:rgb(255,255,255);">b）服务程序热加载；</p>
<p style="padding:0px;margin-top:10px;margin-bottom:10px;line-height:25.2000007629395px;color:rgb(51,51,51);font-size:14px;white-space:normal;font-family:Arial;background-color:rgb(255,255,255);">c）配置分布式存储，稳定可靠；</p>
<h1 style="padding:0px;margin:5px auto;font-size:14px;color:rgb(64,64,64);font-family:'Microsoft YaHei', Verdana, sans-serif, SimSun;line-height:25.2000007629395px;white-space:normal;background-color:rgb(250,250,250);">6&nbsp;<span style="padding:0px;margin:0px;line-height:25.2000007629395px;font-family:'宋体';">实现</span></h1>
<p style="padding:0px;margin-top:10px;margin-bottom:10px;line-height:25.2000007629395px;color:rgb(51,51,51);font-size:14px;white-space:normal;font-family:Arial;background-color:rgb(255,255,255);">功能类ConfMng提供载入xml配置文件到zk系统的函数和读取配置map的函数，并提供一个需要用户实现的抽象函数</p>
<p style="padding:0px;margin-top:10px;margin-bottom:10px;line-height:25.2000007629395px;color:rgb(51,51,51);font-size:14px;white-space:normal;font-family:Arial;background-color:rgb(255,255,255);">// 解析xml将keyvalue存入Map<br style="padding:0px;margin:0px;line-height:10px;">&nbsp;abstract public Map&nbsp;parserXML();</p>
<p style="padding:0px;margin-top:10px;margin-bottom:10px;line-height:25.2000007629395px;color:rgb(51,51,51);font-size:14px;white-space:normal;font-family:Arial;background-color:rgb(255,255,255);">&nbsp;</p>
<p style="padding:0px;margin-top:10px;margin-bottom:10px;line-height:25.2000007629395px;color:rgb(51,51,51);font-size:14px;white-space:normal;font-family:Arial;background-color:rgb(255,255,255);">用户程序使用方法如下：</p>
<p style="padding:0px;margin-top:10px;margin-bottom:10px;line-height:25.2000007629395px;color:rgb(51,51,51);font-size:14px;white-space:normal;font-family:Arial;background-color:rgb(255,255,255);">继承ConfMng类，实现parserXML();接口</p>
<p style="padding:0px;margin-top:10px;margin-bottom:10px;line-height:25.2000007629395px;color:rgb(51,51,51);font-size:14px;white-space:normal;font-family:Arial;background-color:rgb(255,255,255);">读取配置内容。</p>
<p style="padding:0px;margin-top:10px;margin-bottom:10px;line-height:25.2000007629395px;color:rgb(51,51,51);font-size:14px;white-space:normal;font-family:Arial;background-color:rgb(255,255,255);">&nbsp;</p>
<p style="padding:0px;margin-top:10px;margin-bottom:10px;line-height:25.2000007629395px;color:rgb(51,51,51);font-size:14px;white-space:normal;font-family:Arial;background-color:rgb(255,255,255);">原则：设计的集中配置管理类，将读取配置xml的方法开放给用户，做到配置的通用；竟可能在原程序基础上做到无缝结合。&nbsp;</p>
