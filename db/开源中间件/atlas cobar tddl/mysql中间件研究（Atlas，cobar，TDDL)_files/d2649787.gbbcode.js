function GBBCode(a,b){"use strict";function c(a){return/www\.tudou\.com/.test(a)?a+="&autoPlay=true":/www\.56\.com/.test(a)?a+="?auto=1":/player\.video\.qiyi\.com/.test(a)&&(a+="-autoPlay=1"),a}function d(c){c.each(function(){var c,d,e,f,g,h=a(this),i=h.parents(".gbbcode-content"),j=h.data("image"),k=a("<img>");h.replaceWith(k),e=k.css("max-width"),e=null!==e&&"px"===e.slice(-2)?parseInt(e):i.width(),f=e,g=k.parent(),"block"===g.css("display")&&(f=g.width()||f),d=Math.min(e,f),c=b.thumbnail(j,d),null===c.width?k.attr("src",c.src):k.attr(c)})}function e(b){b.each(function(){var b=a(this);b.attr("src",b.attr("src").replace(/\.svg$/,".png"))})}function f(d,e){var f=[];d.each(function(){var b=a(this).data("video-loaded"),c=a(this).data("video");b!==!0&&f.indexOf(c)<0&&f.push(c)}),0!==f.length&&a.ajax({url:"/apis/shortener/url.json",type:"post",data:{url:f},dataType:"json",traditional:!0,success:function(g){g.ok&&(f=[],d.each(function(){var d=a(this),e=d.parents(".gbbcode-content"),f=d.data("video"),h=g.result[f].extradata,j=g.result[f].urltype,k=d.width(),l=d.height();if(h&&void 0!==h.player_type){var m,n,o=h.preview_image,p=c(h.player_url),q=h.player_type,r=h.title+" - "+j.title,s=b.thumbnail(o,k,l);d.attr("title",r).css("background-image","url("+s.src+")").bind("click touch",function(b){var c,f;return"flash"===q&&i===!1?void d.attr("target","_blank"):(b.preventDefault(),d.css("display","none"),void 0===n?n=a('<a data-collapsed href="javascript: void(0)">↑ 收起</a>').data("collapsed",!1).insertAfter(d).bind("click touch",function(a){a.preventDefault(),n.data("collapsed")!==!0&&(m.remove(),m=void 0,d.css("display","block"),n.css("display","none").data("collapsed",!0))}):n.css("display","block").data("collapsed",!1),void(void 0===m&&(m=a("<iframe>").attr({src:p,frameborder:0,allowfullscreen:!0}).insertAfter(d),f=m.css("max-width"),f=null!==f&&"px"===f.slice(-2)?parseInt(f):e.width(),c=Math.min(f,m.parent().width()||f),m.attr({width:c,height:9*c/12}))))}).data("video-loaded",!0)}}),e instanceof Function&&e())}})}function g(b){b.each(function(){var b=a(this);b.bind("load",function(){b.height(b.contents().find("body").height()+50)}),b.height(b.contents().find("body").height()+50)})}var h=document.implementation.hasFeature("http://www.w3.org/TR/SVG11/feature#Shape","1.0")||document.implementation.hasFeature("http://www.w3.org/TR/SVG11/feature#Shape","1.1"),i=!1;try{var j=new ActiveXObject("ShockwaveFlash.ShockwaveFlash");j&&(i=!0)}catch(k){navigator.mimeTypes&&void 0!==navigator.mimeTypes["application/x-shockwave-flash"]&&navigator.mimeTypes["application/x-shockwave-flash"].enabledPlugin&&(i=!0)}return function(b){void 0===b&&(b={}),b.imageSelector=b.imageSelector||"noscript[data-image]",b.videoSelector=b.videoSelector||"a[data-video]",b.mathSelector=b.mathSelector||"img[data-math]",b.pollSelector=b.pollSelector||"iframe[data-poll]",d(a(b.imageSelector)),f(a(b.videoSelector)),g(a(b.pollSelector)),h!==!0&&e(a(b.mathSelector))}}!function(){function a(a){this.message=a}var b="undefined"!=typeof exports?exports:this,c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";a.prototype=new Error,a.prototype.name="InvalidCharacterError",b.btoa||(b.btoa=function(b){for(var d,e,f=String(b),g=0,h=c,i="";f.charAt(0|g)||(h="=",g%1);i+=h.charAt(63&d>>8-g%1*8)){if(e=f.charCodeAt(g+=.75),e>255)throw new a("'btoa' failed: The string to be encoded contains characters outside of the Latin1 range.");d=d<<8|e}return i}),b.atob||(b.atob=function(b){var d=String(b).replace(/=+$/,"");if(d.length%4==1)throw new a("'atob' failed: The string to be decoded is not correctly encoded.");for(var e,f,g=0,h=0,i="";f=d.charAt(h++);~f&&(e=g%4?64*e+f:f,g++%4)?i+=String.fromCharCode(255&e>>(-2*g&6)):0)f=c.indexOf(f);return i})}(),function(a){"use strict";function b(a){var b,c=0;for(b=0;b<a.length;b++)c=a.charCodeAt(b)+(c<<6)+(c<<16)-c<<0;return c}function c(){return a.devicePixelRatio||1}function d(a,c,d,e){var f,g,h,i="",j=a.length;return c=c.replace(/^\/+/,""),j>1?(g=b(c)%j,0>g&&(g+=3),h=a[g]):h=a[0],f="http://"+h+"/"+encodeURI(c),d&&e?i+="/1":(d||e)&&(i+="/3"),d&&(i+="/w/"+d),e&&(i+="/h/"+e),""!==i&&(f=f+"?imageView2"+i),f}function e(a){return a.indexOf("dev.guokr.com")>0}function f(a,b,c){var f,g,h,i,j=k.createElement("a"),m=e(a)?n:o;return j.href=a,i=j.pathname,0===i.indexOf("/image/")?i=i.slice(7):0===i.indexOf("image/")?i=i.slice(6):(0===i.indexOf("/thumbnail/")||0===i.indexOf("thumbnail/"))&&(h=a.replace(l,"$2"),f=h.slice(-2),g={dJ:".gif",pQ:".jpg",BO:".png"}[f],i=h+g),d(m,i,b,c)}function g(a,b,d){var e={src:a,width:null,height:null,"data-hashkey":null,"data-orig-width":null,"data-orig-height":null};if(!l.test(a))return m.test(a)&&(e.src=f(a)),e;e.src=a=f(a);var g=c(),h=a.replace(l,"$2"),i=j(h.replace(/_/g,"/").replace(/-/g,"+")),k=i.charCodeAt(32)+256*i.charCodeAt(33)+65536*i.charCodeAt(34)+16777216*i.charCodeAt(35),n=i.charCodeAt(36)+256*i.charCodeAt(37)+65536*i.charCodeAt(38)+16777216*i.charCodeAt(39);if(e["data-hashkey"]=h,e["data-orig-width"]=k,e["data-orig-height"]=n,void 0===b&&d>0)b=d*k/n;else if(void 0===d&&b>0)d=b*n/k;else if(1>b||1>d)return e;return(b*g>k||d*g>n)&&(g=1,k>b&&n>d?g=Math.min(k/b,n/d):(b=k>b?b:k,d=n>d?d:n)),e.width=Math.round(b),e.height=Math.round(d),b=Math.round(b*g),d=Math.round(d*g),(Math.abs(k-b)>1||Math.abs(n-d)>1)&&(e.src=f(a,b,d)),e}function h(a){return(l.test(a)||m.test(a))&&(a=f(a)),a}var i,j=a.atob||require("Base64").atob,k=a.document||require("jsdom").jsdom(),l=/^http:\/\/(img1\.(?:\w+\.)?guokr\.com(?:\:\d+)?\/(?:image|thumbnail)|\d+\.im(?:\.dev)?\.guokr\.com(?:\:\d+)?)\/([\w-]{56})(?:_\d*x\d*)?\.(jpg|png|gif)(\?.*|$)/,m=/^(http:\/\/(?:\w+\.)*guokr\.com(?:\:\d+)?)?(\/gkimage\/[a-z0-9\/]{15}\.(gif|jpe?g|png))(\?.*|$)/,n=["1.im.dev.guokr.com","2.im.dev.guokr.com","3.im.dev.guokr.com"],o=["1.im.guokr.com","2.im.guokr.com","3.im.guokr.com"];i={sdbm:b,thumbnail:g,original:h,public_url:f},"function"==typeof define&&define.amd?define(["Base64"],function(){return i}):"undefined"!=typeof a?("undefined"!=typeof module&&module.exports&&(a=module.exports=i),a.gkimage=i):window.gkimage=i}("object"==typeof exports&&exports||this),window.G?G.req(["jQuery"],function(a){GBBCode(a,window.gkimage)()}):window.jQuery?jQuery(function(a){GBBCode(a,window.gkimage)()}):window.Zepto&&Zepto(document).ready(function(a){GBBCode(a,window.gkimage)()});